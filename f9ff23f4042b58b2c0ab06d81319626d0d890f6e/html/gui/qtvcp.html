<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 9.0.0rc2" />
<title>QtVCP</title>
<link rel="stylesheet" href="..//asciidoc.css" type="text/css" />


<link rel="stylesheet" href="..//linuxcnc.css" type="text/css" />
<script type="text/javascript" src="..//asciidoc.js"></script>
<script type="text/javascript">
/*<![CDATA[*/
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="book">
<div id="header">
<h1>QtVCP</h1>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph" id="cha:qtvcp"><p>QtVCP is an <strong>infrastructure to build custom CNC screens or control
panels for LinuxCNC</strong>.</p></div>
<div class="paragraph"><p>It displays a <em><code>.ui</code> file built with Qt Designer</em> screen editor and
combines this with <em>Python programming</em> to create a GUI screen for
running a CNC machine.</p></div>
<div class="paragraph"><p>QtVCP is completely <em>customizable</em>: you can add different buttons and
status LEDs etc. or add Python code for even finer grain customization.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_showcase">1. Showcase</h2>
<div class="sectionbody">
<div class="paragraph"><p>Few examples of QtVCP built screens and virtual control panels:</p></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<figure>
<img src="images/silverdragon.png" alt="QtDragon Router"/>
<figcaption class="title"> Figure 1. QtDragon - 3/4-Axis Sample</figcaption>
</figure>
</div>
</div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<figure>
<img src="images/qt_cnc.png" alt="Qtscreen Mill"/>
<figcaption class="title"> Figure 2. QtDefault - 3-Axis Sample</figcaption>
</figure>
</div>
</div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<figure>
<img src="images/qtaxis.png" alt="Qtscreen QtAxis"/>
<figcaption class="title"> Figure 3. QtAxis - Self Adjusting Axis Sample</figcaption>
</figure>
</div>
</div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<figure>
<img src="images/blender.png" alt="Qtscreen Blender"/>
<figcaption class="title"> Figure 4. Blender - 4-Axis Sample</figcaption>
</figure>
</div>
</div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<figure>
<img src="images/x1mill.png" alt="Qtscreen x1mill"/>
<figcaption class="title"> Figure 5. X1mill - 4-Axis Sample</figcaption>
</figure>
</div>
</div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<figure>
<img src="images/qtvcp-cam-align.png" alt="Qtscreen x1mill"/>
<figcaption class="title"> Figure 6. cam_align - Camera Alignment VCP</figcaption>
</figure>
</div>
</div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<figure>
<img src="images/test_panel.png" alt="Test Panel"/>
<figcaption class="title"> Figure 7. test_panel - Test Panel VCP</figcaption>
</figure>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec:qtvcp-overview">2. Overview</h2>
<div class="sectionbody">
<div class="paragraph"><p><em>Two files are used, individually or in combination</em>, to
add customizations:</p></div>
<div class="ulist"><ul>
<li>
<p>
A <strong>UI file</strong> that is a <em>XML</em> file made with <em>Qt Designer</em> graphical editor.
</p>
</li>
<li>
<p>
A <strong>handler file</strong> which is a <em>Python</em> code text file.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Normally QtVCP uses the stock UI and handler file, but you can specify
QtVCP to use <em>local</em> UI and handler files.<br />
A <strong><em>local</em> file</strong> is one that is in the <em>configuration folder</em> that defines
the rest of the machine&#8217;s requirements.</p></div>
<div class="paragraph"><p>One is not restricted to adding a custom panel on the right or a custom
tab as QtVCP leverages <em>Qt Designer</em> (the editor) and <em>PyQT5</em> (the
widget toolkit).</p></div>
<div class="paragraph"><p>QtVCP has some added <strong>special LinuxCNC widgets and actions</strong>.<br />
There are special widgets to bridge third party widgets to HAL pins.<br />
It&#8217;s possible to create widget responses by connecting signals to
Python code in the handler file.</p></div>
<div class="sect2">
<h3 id="_qtvcp_widgets">2.1. QtVCP Widgets</h3>
<div class="paragraph"><p>QtVCP uses the <strong>PyQt5 toolkit&#8217;s widgets</strong> for LinuxCNC integration.</p></div>
<div class="paragraph"><p><strong>Widget</strong> is the <em>general name for user interface objects</em> such as buttons
and labels in PyQT5.</p></div>
<div class="paragraph"><p>You are free to use any available <strong>default widgets</strong> in the Qt Designer
editor.</p></div>
<div class="paragraph"><p>There are also <strong>special widgets</strong> made for LinuxCNC that make integration
easier.<br />
These are split in three heading on the left side of the editor:</p></div>
<div class="ulist"><ul>
<li>
<p>
One is for <em>HAL only widgets</em>;
</p>
</li>
<li>
<p>
One is for <em>CNC control widgets</em>;
</p>
</li>
<li>
<p>
One is for <em>Dialog widgets</em>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>You are free to mix them in any way on your panel.</p></div>
<div class="paragraph"><p>A very important widget for CNC control is the <strong><code>ScreenOptions</code> widget</strong>:
it does not add anything visually to the screen but, allows important
details to be selected rather then be coded in the handler file.</p></div>
</div>
<div class="sect2">
<h3 id="_ini_settings">2.2. INI Settings</h3>
<div class="paragraph"><p>If you are using QtVCP to make a CNC motion control screen (rather then a HAL based panel), in the INI file,
in the <code>[DISPLAY]</code> section, add a line with the following pattern:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">DISPLAY </span></span><span style="font-weight: bold"><span style="color: #000000">=</span></span><span style="color: #009900"> qtvcp &lt;options&gt; &lt;screen_name&gt;</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">All <code>&lt;options&gt;</code> must appear before <code>&lt;screen_name&gt;</code>.</td>
</tr></table>
</div>
<div class="ulist"><div class="title">Options</div><ul>
<li>
<p>
<code>-d</code> Debugging on.
</p>
</li>
<li>
<p>
<code>-i</code> Enable info output.
</p>
</li>
<li>
<p>
<code>-v</code> Enable verbose debug output.
</p>
</li>
<li>
<p>
<code>-q</code> Enable only error debug output.
</p>
</li>
<li>
<p>
<code>-a</code> Set window always on top.
</p>
</li>
<li>
<p>
<code>-c NAME</code> HAL component name. Default is to use the UI file name.
</p>
</li>
<li>
<p>
<code>-g GEOMETRY</code> Set geometry WIDTHxHEIGHT+XOFFSET+YOFFSET. Values are in pixel units,
  XOFFSET/YOFFSET is referenced from top left of screen.
  Use -g WIDTHxHEIGHT for just setting size or -g +XOFFSET+YOFFSET for just position.
  Example: <code>-g 200x400+0+100</code>
</p>
</li>
<li>
<p>
<code>-H FILE</code> Execute hal statements from FILE with halcmd after the component is set up and ready.
</p>
</li>
<li>
<p>
<code>-m</code> Maximize window.
</p>
</li>
<li>
<p>
<code>-f</code> Fullscreen the window.
</p>
</li>
<li>
<p>
<code>-t THEME</code> Default is system theme
</p>
</li>
<li>
<p>
<code>-x XID</code> Embed into a X11 window that doesn&#8217;t support embedding.
</p>
</li>
<li>
<p>
<code>--push_xid</code> Send QtVCP&#8217;s X11 window id number to standard output; for embedding.
</p>
</li>
<li>
<p>
<code>-u USERMOD</code> File path of a substitute handler file.
</p>
</li>
<li>
<p>
<code>-o USEROPTS</code> Pass a string to QtVCP&#8217;s handler file under <code>self.w.USEROPTIONS_</code> list variable. Can be multiple -o.
</p>
</li>
</ul></div>
<div class="paragraph"><div class="title">&lt;screen_name&gt;</div><p><code>&lt;screen_name&gt;</code> is the <em>base name of the .ui and _handler.py files</em>.
If <code>&lt;screen_name&gt;</code> is missing, the default screen will be loaded.</p></div>
<div class="paragraph"><p>QtVCP assumes the UI file and the handler file use the <strong>same base name</strong>.
QtVCP will first search the LinuxCNC configuration directory that was launched for the files, then in the system skin folder holding standard screens.</p></div>
<div class="listingblock">
<div class="title">Cycle Times</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">[DISPLAY]</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">CYCLE_TIME </span></span><span style="font-weight: bold"><span style="color: #000000">=</span></span><span style="color: #009900"> 100</span>
<span style="font-weight: bold"><span style="color: #0000FF">GRAPHICS_CYCLE_TIME </span></span><span style="font-weight: bold"><span style="color: #000000">=</span></span><span style="color: #009900"> 100</span>
<span style="font-weight: bold"><span style="color: #0000FF">HALPIN_CYCLE </span></span><span style="font-weight: bold"><span style="color: #000000">=</span></span><span style="color: #009900"> 100</span></tt></pre></div></div>
<div class="paragraph"><p>Adjusts the response rate of the GUI updates in milliseconds.
Defaults to 100, useable range 50 - 200.</p></div>
<div class="paragraph"><p>The widgets, graphics and HAL pin update can be set separately.</p></div>
<div class="paragraph"><p>If the update time is not set right the screen can become unresponsive or very jerky.</p></div>
</div>
<div class="sect2">
<h3 id="_qt_designer_ui_file">2.3. Qt Designer UI File</h3>
<div class="paragraph"><p>A Qt Designer file is a text file organized in the <em>XML</em> standard that describes the <strong>layout and widgets</strong> of the screen.</p></div>
<div class="paragraph"><p><em>PyQt5</em> uses this file to build the display and react to those widgets.</p></div>
<div class="paragraph"><p>The Qt Designer editor makes it relatively easy to build and edit this file.</p></div>
</div>
<div class="sect2">
<h3 id="_handler_files">2.4. Handler Files</h3>
<div class="paragraph"><p>A handler file is a file containing <em>Python</em> code, which <strong>adds to QtVCP default routines</strong>.</p></div>
<div class="paragraph"><p>A handler file allows one to <em>modify defaults</em>, or <em>add logic</em> to a QtVCP screen without having to modify QtVCP&#8217;s core code.
In this way you can have <strong>custom behaviors</strong>.</p></div>
<div class="paragraph"><p>If present a handler file will be loaded.
<strong>Only one file</strong> is allowed.</p></div>
</div>
<div class="sect2">
<h3 id="_libraries_modules">2.5. Libraries Modules</h3>
<div class="paragraph"><p>QtVCP, as built, does little more than display the screen and react to widgets.
For more <strong>prebuilt behaviors</strong> there are available libraries (found in <code>lib/python/qtvcp/lib</code> in RIP LinuxCNC install).</p></div>
<div class="paragraph"><p><strong>Libraries</strong> are prebuilt <em>Python modules</em> that <strong>add features</strong> to QtVCP.
In this way you can select what features you want - yet don&#8217;t have to build common ones yourself.</p></div>
<div class="paragraph"><p>Such libraries include:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>audio_player</code>
</p>
</li>
<li>
<p>
<code>aux_program_loader</code>
</p>
</li>
<li>
<p>
<code>keybindings</code>
</p>
</li>
<li>
<p>
<code>message</code>
</p>
</li>
<li>
<p>
<code>preferences</code>
</p>
</li>
<li>
<p>
<code>notify</code>
</p>
</li>
<li>
<p>
<code>virtual_keyboard</code>
</p>
</li>
<li>
<p>
<code>machine_log</code>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_themes">2.6. Themes</h3>
<div class="paragraph"><p>Themes are a way to modify the <strong>look and feel</strong> of the widgets on the screen.</p></div>
<div class="paragraph"><p>For instance the <em>color</em> or <em>size</em> of buttons and sliders can be changed using themes.</p></div>
<div class="paragraph"><p>The <em>Windows theme</em> is default for screens.<br />
The <em>System theme</em> is default for panels.</p></div>
<div class="paragraph"><p>To see available themes, they can be loaded by running the following command in a terminal:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>qtvcp -d -t &lt;theme_name&gt;</code></pre>
</div></div>
<div class="paragraph"><p>QtVCP can also be customized with <em>Qt stylesheets (QSS)</em> using CSS.</p></div>
</div>
<div class="sect2">
<h3 id="_local_files">2.7. Local Files</h3>
<div class="paragraph"><p>If present, local UI/QSS/Python files in the configuration folder will be loaded instead of the stock UI files.</p></div>
<div class="paragraph"><p>Local UI/QSS/Python files allow you to use your customized designs rather than the default screens.</p></div>
<div class="paragraph"><p>QtVCP will look for a folder named &lt;screen_name&gt; (in the launched configuration folder that holds the INI file).</p></div>
<div class="paragraph"><p>In that folder, QtVCP will load any of the available following files:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>&lt;screen_name&gt;.ui</code>,
</p>
</li>
<li>
<p>
<code>&lt;screen_name&gt;_handler.py</code>, and
</p>
</li>
<li>
<p>
<code>&lt;screen_name&gt;.qss</code>.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="cha:qtvcp:modifying-screens">2.8. Modifying Stock Screens</h3>
<div class="paragraph"><p>There are <em>three ways</em> to customize a screen/panel.</p></div>
<div class="sect3">
<h4 id="_minor_stylesheet_changes">2.8.1. Minor StyleSheet Changes</h4>
<div class="paragraph"><p>Stylesheets can be used to <strong>set Qt properties</strong>.
If a widget uses properties then they usually can be modified by stylesheets.</p></div>
<div class="listingblock">
<div class="title">Example of a widget with accompanying style sheet settings.</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>State_LED <span style="color: #993399">#name_of_led</span><span style="color: #FF0000">{</span>
  <span style="color: #0000FF">qproperty-color:</span> <span style="font-style: italic"><span style="color: #009900">red</span></span>;
  <span style="color: #0000FF">qproperty-diameter:</span> <span style="font-style: italic"><span style="color: #009900">20</span></span>;
  <span style="color: #0000FF">qproperty-flashRate:</span> <span style="font-style: italic"><span style="color: #009900">150</span></span>;
  <span style="color: #FF0000">}</span></tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_minor_python_code_changes">2.8.2. Minor Python Code Changes</h4>
<div class="paragraph"><p>Another Python file can be used to <strong>add commands</strong> to the screen, after the handler file is parsed.
This can be useful for minor changes while still honouring standard handler updates from linuxcnc repositoies.</p></div>
<div class="paragraph"><p>In the <em>INI file</em> under the <code>[DISPLAY]</code> heading add <strong><code>USER_COMMAND_FILE = _PATH_</code></strong><br /></p></div>
<div class="paragraph"><p><em>PATH</em> can be any valid path.
It can use <code>~</code> for home directory or <code>WORKINGDIRECTORY</code> or <code>CONFIGDIRECTORY</code> to represent QtVCP&#8217;s idea of those directories:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000000">[DISPLAY]</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">USER_COMMAND_FILE </span></span><span style="font-weight: bold"><span style="color: #000000">=</span></span><span style="color: #009900"> CONFIGDIRECTORY/&lt;screen_name_added_commands&gt;</span></tt></pre></div></div>
<div class="paragraph"><p>If no entry is found in the <em>INI</em>, QtVCP will look in the <strong>default path</strong>.
The default path is in the configuration directory as a hidden file using the screen basename and rc, e.g., <strong><code>CONFIGDIRECTORY/.&lt;screen_name&gt;rc</code></strong>.</p></div>
<div class="paragraph"><p>This file will be read and executed as Python code in the <strong>handler file context</strong>.</p></div>
<div class="paragraph"><p><strong>Only local functions and local attributes</strong> can be referenced.<br />
Global libraries defined in the screen&#8217;s handler file can be referenced but must be preceded with <em>self.</em><br />
These are usually seen as all capital words with no preceding self.<br />
<em>self</em> references the window class<br />
<em>self.w</em> typically references the widgets</p></div>
<div class="paragraph"><p>What can be used can vary by screen and development cycle.</p></div>
<div class="paragraph"><div class="title">A simple example</div><p>Reference the main window to change the title (Won&#8217;t show if using INI entries for title change)</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>self<span style="color: #990000">.</span>w<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setWindowTitle</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'My Title Test'</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><div class="title">An advanced instance patching example</div><p>This could work with the Qtdragon screen&#8217;s handler file.<br />
Here we show how to add new functions and override existing ones.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># needed to instance patch</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># reference: https://ruivieira.dev/python-monkey-patching-for-readability.html</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> types

<span style="font-style: italic"><span style="color: #9A1900"># This is actually an unbounded function with 'obj' as a parameter.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># You call this function without the usual preceding 'self.'</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># This is because will will not be patching it into the original handler class instance</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># It will only be called from code in this file</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_function</span></span><span style="color: #990000">(</span>obj<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">print</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">dir</span></span><span style="color: #990000">(</span>obj<span style="color: #990000">))</span>

<span style="font-style: italic"><span style="color: #9A1900"># This is a new function we will added to the existing handler class instance.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># Notice it calls the unbounded function with 'self' as an parameter</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># 'self' is the only global reference available. It references the window instance</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">on_keycall_F10</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>event<span style="color: #990000">,</span>state<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> state<span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">print</span></span> <span style="color: #990000">(</span><span style="color: #FF0000">'F10'</span><span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #000000">test_function</span></span><span style="color: #990000">(</span>self<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900"># This will be used to override an existing function in the existing handler class instance</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># note we also call a copy of the original function too</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># this shows how to extend an existing function to do extra functions</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">on_keycall_F11</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>event<span style="color: #990000">,</span>state<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> state<span style="color: #990000">:</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">on_keycall_F11_super</span></span><span style="color: #990000">(</span>event<span style="color: #990000">,</span>state<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #0000FF">print</span></span> <span style="color: #990000">(</span><span style="color: #FF0000">'Hello'</span><span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900"># We are referencing the KEYBIND library that was instantiated in the</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># original handler class instance by adding 'self.' to it.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># This function tells KEYBIND to call 'on_keycall_F10' when F10 is pressed</span></span>
self<span style="color: #990000">.</span>KEYBIND<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">add_call</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Key_F10'</span><span style="color: #990000">,</span><span style="color: #FF0000">'on_keycall_F10'</span><span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900"># Here we are instance patching the original handler file to add a new</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># function that calls our new function (of the same name)</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># defined in this file</span></span>
self<span style="color: #990000">.</span>on_keycall_F10 <span style="color: #990000">=</span> types<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">MethodType</span></span><span style="color: #990000">(</span>on_keycall_F10<span style="color: #990000">,</span> self<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900"># Here we are defining a copy of the original 'on_keycall_F11' function</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># so we can call it later. we can use any valid, unused function name.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># We need to do this before overriding the original function.</span></span>
self<span style="color: #990000">.</span>on_keycall_F11_super <span style="color: #990000">=</span> self<span style="color: #990000">.</span>on_keycall_F11

<span style="font-style: italic"><span style="color: #9A1900"># Here we are instance patching the original handler file to override</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># an existing function to point to our new function (of the same name)</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># defined in this file</span></span>
self<span style="color: #990000">.</span>on_keycall_F11 <span style="color: #990000">=</span> types<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">MethodType</span></span><span style="color: #990000">(</span>on_keycall_F11<span style="color: #990000">,</span> self<span style="color: #990000">)</span>
</tt></pre></div></div>
</div>
<div class="sect3">
<h4 id="_full_creative_control_with_custom_handler_ui_files">2.8.3. Full Creative Control with custom handler/ui files</h4>
<div class="paragraph"><p>If you wish to <strong>modify a stock screen</strong> with full control, <em>copy it&#8217;s UI
and handler file to your configuration folder</em>.</p></div>
<div class="paragraph"><p>There is a QtVCP panel to help with this:</p></div>
<div class="ulist"><ul>
<li>
<p>
Open a terminal and run the following command:
</p>
<div class="listingblock">
<div class="content">
<pre><code>qtvcp copy_dialog</code></pre>
</div></div>
</li>
<li>
<p>
Select the screen and destination folder in the dialog
</p>
</li>
<li>
<p>
If you wish to <strong>name your screen</strong> differently than the builtin screen&#8217;s default name, change the <em>basename</em> in the edit box.
</p>
</li>
<li>
<p>
There should be a folder in the config folder; for screens: named <em>&lt;CONFIG FOLDER&gt;/qtvcp/screens/</em> for panels:  named <em>&lt;CONFIG FOLDER&gt;/qtvcp/panels/</em> add the folders if ther are missing and copy your folder/files in it.
</p>
</li>
<li>
<p>
Validate to copy all the files
</p>
</li>
<li>
<p>
Delete the files you don&#8217;t wish to modify so that the original files will be used.
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec:qtvcp:vcp-panels">3. VCP Panels</h2>
<div class="sectionbody">
<div class="paragraph"><p>QtVCP can be used to create control panels that interface with <strong>HAL</strong>.</p></div>
<div class="sect2">
<h3 id="_builtin_panels">3.1. Builtin Panels</h3>
<div class="paragraph"><p>There are several <strong>builtin HAL panels</strong> available.</p></div>
<div class="paragraph"><p>In a terminal type <code>qtvcp &lt;return&gt;</code> to see a list:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong><code>test_panel</code></strong>
</dt>
<dd>
<p>
Collection of useful widgets for testing HAL components, including speech of LED state.
</p>
<div class="imageblock" style="text-align:center;">
<div class="content">
<figure>
<img src="images/qtvcp_test_panel.png" alt="QtVCP HAL Test Builtin Panel"/>
<figcaption class="title"> Figure 8. QtVCP HAL Test Builtin Panel</figcaption>
</figure>
</div>
</div>
</dd>
<dt class="hdlist1">
<strong><code>cam_align</code></strong>
</dt>
<dd>
<p>
A camera display widget for rotational alignment.
</p>
<div class="imageblock" style="text-align:center;">
<div class="content">
<figure>
<img src="images/qtvcp-cam-align.png" alt="Qtscreen x1mill"/>
<figcaption class="title"> Figure 9. cam_align - Camera Alignment VCP</figcaption>
</figure>
</div>
</div>
</dd>
<dt class="hdlist1">
<strong><code>sim_panel</code></strong>
</dt>
<dd>
<p>
  A small control panel to simulate MPG jogging controls etc.<br />
  For simulated configurations.
</p>
<div class="imageblock" style="text-align:center;">
<div class="content">
<figure>
<img src="images/qtvcp_sim_panel.png" alt="QtVCP Sim Builtin Panel"/>
<figcaption class="title"> Figure 10. QtVCP Sim Builtin Panel</figcaption>
</figure>
</div>
</div>
</dd>
<dt class="hdlist1">
<strong><code>vismach_mill_xyz</code></strong>
</dt>
<dd>
<p>
3D OpenGL view of a 3-axis milling machine.
</p>
<div class="imageblock" style="text-align:center;">
<div class="content">
<figure>
<img src="images/qtvismach.png" alt="QtVismach - 3-Axis Mill Builtin Panel"/>
<figcaption class="title"> Figure 11. QtVismach - 3-Axis Mill Builtin Panel</figcaption>
</figure>
</div>
</div>
</dd>
</dl></div>
<div class="paragraph"><p>You can load these from the terminal or from a HAL file with this basic command:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">loadusr</span></span> <span style="font-weight: bold"><span style="color: #000000">qtvcp</span></span> <span style="font-weight: bold"><span style="color: #000000">test_panel</span></span></tt></pre></div></div>
<div class="paragraph"><p>But more typically like this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">loadusr</span></span> -<span style="font-weight: bold"><span style="color: #000000">Wn</span></span> <span style="font-weight: bold"><span style="color: #000000">test_panel</span></span> <span style="font-weight: bold"><span style="color: #000000">qtvcp</span></span> <span style="font-weight: bold"><span style="color: #000000">test_panel</span></span></tt></pre></div></div>
<div class="paragraph"><p>In this way HAL will wait till the HAL pins are made before continuing on.</p></div>
</div>
<div class="sect2">
<h3 id="_custom_panels">3.2. Custom Panels</h3>
<div class="paragraph"><p>You can of course <strong>make your own panel and load it</strong>.</p></div>
<div class="paragraph"><p>If you made a UI file named <code>my_panel.ui</code> and a HAL file named <code>my_panel.hal</code>, you would then load this from a terminal with:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>halrun -I -f my_panel.hal</code></pre>
</div></div>
<div class="listingblock">
<div class="title">Example HAL file loading a QtVCP panel</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># load realtime components</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">loadrt</span></span> <span style="font-weight: bold"><span style="color: #000000">threads</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">loadrt</span></span> <span style="font-weight: bold"><span style="color: #000000">classicladder_rt</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># load non-realtime programs</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">loadusr</span></span> <span style="font-weight: bold"><span style="color: #000000">classicladder</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">loadusr</span></span> -<span style="font-weight: bold"><span style="color: #000000">Wn</span></span> <span style="font-weight: bold"><span style="color: #000000">my_panel</span></span> <span style="font-weight: bold"><span style="color: #000000">qtvcp</span></span> <span style="color: #009900">my_panel.ui</span>  <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;1&gt;</b></span></span>

<span style="font-style: italic"><span style="color: #9A1900"># add components to thread</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">addf</span></span> <span style="color: #009900">classicladder.0.refresh</span> <span style="font-weight: bold"><span style="color: #000000">thread1</span></span>


<span style="font-style: italic"><span style="color: #9A1900"># connect pins</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">net</span></span> <span style="font-weight: bold"><span style="color: #000000">bit-input1</span></span>     <span style="color: #009900">test_panel.checkbox_1</span>        <span style="color: #009900">classicladder.0.in-00</span>
<span style="font-weight: bold"><span style="color: #0000FF">net</span></span> <span style="font-weight: bold"><span style="color: #000000">bit-hide</span></span>       <span style="color: #009900">test_panel.checkbox_4</span>        <span style="color: #009900">classicladder.0.hide_gui</span>

<span style="font-weight: bold"><span style="color: #0000FF">net</span></span> <span style="font-weight: bold"><span style="color: #000000">bit-output1</span></span>    <span style="color: #009900">test_panel.led_1</span>             <span style="color: #009900">classicladder.0.out-00</span>

<span style="font-weight: bold"><span style="color: #0000FF">net</span></span> <span style="font-weight: bold"><span style="color: #000000">s32-in1</span></span>        <span style="color: #009900">test_panel.doublescale_1-s</span>   <span style="color: #009900">classicladder.0.s32in-00</span>

<span style="font-style: italic"><span style="color: #9A1900"># start thread</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">start</span></span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
In this case we load <code>qtvcp</code> using <strong><code>-Wn</code></strong> which waits for the panel to finish loading before continuing to run the next HAL command.<br />
    This is to <em>ensure that the panel created HAL pins are actually done</em> in case they are used in the rest of the file.
</p>
</li>
</ol></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_a_simple_clean_sheet_custom_screen">4. Build A Simple Clean-sheet Custom Screen</h2>
<div class="sectionbody">
<div class="imageblock" style="text-align:center;">
<div class="content">
<figure>
<img src="images/qtvcp_tester.png" alt="QtVCP Ugly custom screen"/>
<figcaption class="title"> Figure 12. QtVCP Ugly custom screen</figcaption>
</figure>
</div>
</div>
<div class="sect2">
<h3 id="_overview">4.1. Overview</h3>
<div class="paragraph"><p>To build a panel or screen:</p></div>
<div class="ulist"><ul>
<li>
<p>
Use Qt Designer to build a design you like and save it to your configuration folder with a name of your choice, ending with <code>.ui</code>
</p>
</li>
<li>
<p>
Modify the configuration INI file to load QtVCP using your new <code>.ui</code> file.
</p>
</li>
<li>
<p>
Then connect any required HAL pins in a HAL file.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_get_qt_designer_to_include_linuxcnc_widgets">4.2. Get Qt Designer To Include LinuxCNC Widgets</h3>
<div class="paragraph"><div class="title">Install Qt Designer</div><p>First you must have the <strong>Qt Designer installed</strong>.<br />
The following commands should add it to your system, or use your package manager to do the same:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>sudo apt-get install qttools5-dev-tools qttools5-dev libpython3-dev</code></pre>
</div></div>
<div class="paragraph"><div class="title">Add <code>qtvcp_plugin.py</code> link to the Qt Designer Search Path</div><p>Then you must add a link to the <code>qtvcp_plugin.py</code> in one of the folders that Qt Designer will search into.</p></div>
<div class="paragraph"><p>In a <em>RIP</em> version of LinuxCNC <code>qtvcp_plugin.py</code> will be:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>'~/LINUXCNC_PROJECT_NAME/lib/python/qtvcp/plugins/qtvcp_plugin.py'</code></pre>
</div></div>
<div class="paragraph"><p>For a <em>Package installed</em> version it should be:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>'usr/lib/python2.7/qtvcp/plugins/qtvcp_plugin.py' or
'usr/lib/python2.7/dist-packages/qtvcp/plugins/qtvcp_plugin.py'</code></pre>
</div></div>
<div class="paragraph"><p>Make a symbolic link to the above file and move it to one of the places Qt Designer searches in.</p></div>
<div class="paragraph"><p>Qt Designer searches in these two place for links (pick one):</p></div>
<div class="literalblock">
<div class="content">
<pre><code>'/usr/lib/x86_64-linux-gnu/qt5/plugins/designer/python' or
'~/.designer/plugins/python'</code></pre>
</div></div>
<div class="paragraph"><p>You may need to create the <code>plugins/python</code> folder.</p></div>
<div class="ulist"><div class="title">Start Qt Designer:</div><ul>
<li>
<p>
For a <em>RIP install</em>:<br />
  Open a terminal, set the environment for LinuxCNC &lt;1&gt;, then load Qt Designer &lt;2&gt; with :
</p>
<div class="listingblock">
<div class="content">
<pre><code>. scripts/rip-environment   <b>&lt;1&gt;</b>
designer -qt=5              <b>&lt;2&gt;</b></code></pre>
</div></div>
</li>
<li>
<p>
For a <em>package install</em>:<br />
  Open a terminal and type:
</p>
<div class="listingblock">
<div class="content">
<pre><code>designer -qt=5</code></pre>
</div></div>
</li>
</ul></div>
<div class="paragraph"><p>If all goes right, Qt Designer will launch and you will see the selectable LinuxCNC widgets on the left hand side.</p></div>
</div>
<div class="sect2">
<h3 id="_build_the_screen_code_ui_code_file">4.3. Build The Screen <code>.ui</code> File</h3>
<div class="paragraph"><div class="title">Create <code>MainWindow</code> Widget</div><p>When Qt Designer is first started there is a <em>'New Form' dialog</em> displayed.<br />
Pick <em>'Main Window'</em> and press the <em>'Create'</em> button.<br />
A <em><code>MainWindow</code> widget</em> is displayed.</p></div>
<div class="paragraph"><p>We are going to make this window a specific non resizeable size:</p></div>
<div class="ulist"><div class="title">Set <code>MainWindow</code> Minimum and Maximum Size</div><ul>
<li>
<p>
Grab the corner of the window and resize to an appropriate size, say 1000x600.<br />
</p>
</li>
<li>
<p>
Right click on the window and click set <em>minimum size</em>.
</p>
</li>
<li>
<p>
Do it again and set <em>maximum size</em>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Our sample widget will now not be resizable.</p></div>
<div class="paragraph"><div class="title">Add the <code>ScreenOptions</code> Widget</div><p>Drag and drop the <code>ScreenOptions</code> widget anywhere onto the main window.</p></div>
<div class="paragraph"><p>This widget doesn&#8217;t add anything visually but sets up some <strong>common options</strong>.</p></div>
<div class="paragraph"><p>It&#8217;s recommended to always <em>add this widget before any other</em>.</p></div>
<div class="paragraph"><p>Right click on the main window, not the <code>ScreenOptions</code> widget, and set the <em>layout</em> as vertical to make the <code>ScreenOptions</code> fullsized.</p></div>
<div class="paragraph"><div class="title">Add Panel Content</div><p>On the right hand side there is a panel with tabs for a <em>Property editor</em> and an <em>Object inspector</em>.</p></div>
<div class="paragraph"><p>On the Object inspector click on the <em>ScreenOptions</em>.<br />
Then switch to the Property Editor and, under the <em>ScreenOptions</em> heading, toggle <strong><code>filedialog_option</code></strong>.</p></div>
<div class="paragraph"><p>Drag and drop a <strong><code>GCodeGraphics</code></strong> <em>widget</em> and a <strong><code>GcodeEditor</code></strong> <em>widget</em>.<br />
Place and resize them as you see fit leaving some room for buttons.</p></div>
<div class="paragraph"><div class="title">Add Action Buttons</div><p>Add 7 action buttons on to the main window.</p></div>
<div class="paragraph"><p>If you double click the button, you can add text.<br />
Edit the button labels for <em>Estop</em>, <em>Machine On</em>, <em>Home</em>, <em>Load</em>, <em>Run</em>, <em>Pause</em> and <em>stop</em>.</p></div>
<div class="paragraph"><p>Action buttons <em>default to no action</em> so we must change the properties for defined functions. You can edit the properties:</p></div>
<div class="ulist"><ul>
<li>
<p>
directly in the <em>property editor</em> on the right side of Qt Designer, or
</p>
</li>
<li>
<p>
conveniently, left double clicking on the button to launch a <em>properties dialog</em> that allows selecting actions while only displaying relevant data to the action.
</p>
</li>
</ul></div>
<div class="paragraph"><p>We will describe the convenient way first:</p></div>
<div class="ulist"><ul>
<li>
<p>
Right click the <em>Machine On</em> button and select <em>Set Actions</em>.
</p>
</li>
<li>
<p>
When the dialog displays, use the combobox to navigate to <code>MACHINE CONTROLS - Machine On</code>.
</p>
</li>
<li>
<p>
In this case there is no option for this action so select <em>OK</em>.<br />
</p>
</li>
</ul></div>
<div class="paragraph"><p>Now the button will turn the machine on when pressed.</p></div>
<div class="paragraph"><p>And now the direct way with Qt Designer&#8217;s property editor:</p></div>
<div class="ulist"><ul>
<li>
<p>
Select the <em>Machine On</em> button.
</p>
</li>
<li>
<p>
Go to the Property Editor on the right side of Qt Designer.
</p>
</li>
<li>
<p>
Scroll down until you find the <em>ActionButton</em> heading.
</p>
</li>
<li>
<p>
Click  the <code>machine_on</code> action checkbox you will see in the list of properties and values.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The button will now control machine on/off.</p></div>
<div class="paragraph"><p>Do the same for all the other button with the addition of:</p></div>
<div class="ulist"><ul>
<li>
<p>
With the <em>Home</em> button we must also change the <code>joint_number</code> property to <code>-1</code>.<br />
  This tells the controller to <em>home all the axes</em> rather then a specific axis.
</p>
</li>
<li>
<p>
With the <em>Pause</em> button:
</p>
<div class="ulist"><ul>
<li>
<p>
Under the <code>Indicated_PushButton</code> heading check the <code>indicator_option</code>.
</p>
</li>
<li>
<p>
Under the <code>QAbstactButton</code> heading check <code>checkable</code>.
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<figure>
<img src="images/designer_button_property.png" alt="Qt Designer: Selecting Pause Button's Properties"/>
<figcaption class="title"> Figure 13. Qt Designer: Selecting Pause Button&#8217;s Properties</figcaption>
</figure>
</div>
</div>
<div class="paragraph"><div class="title">Save The <code>.ui</code> File</div><p>We then need to save this design as <code>tester.ui</code> in the <code>sim/qtvcp</code> folder.</p></div>
<div class="paragraph"><p>We are saving it as <em>tester</em> as that is a file name that QtVCP recognizes and will use a built in handler file to display it.</p></div>
</div>
<div class="sect2">
<h3 id="_handler_file">4.4. Handler file</h3>
<div class="paragraph"><p>A handler file is <strong>required</strong>.</p></div>
<div class="paragraph"><p>It allows customizations to be written in Python.</p></div>
<div class="paragraph"><p>For instance, <em>keyboard controls</em> are usually written in the handler file.</p></div>
<div class="paragraph"><p>In this example, the built in file <code>tester_handler.py</code> is automatically used:
It does the minimum required to display the <code>tester.ui</code> defined screen and do basic keyboard jogging.</p></div>
</div>
<div class="sect2">
<h3 id="_ini_configuration">4.5. INI Configuration</h3>
<div class="paragraph"><div class="title">[DISPLAY] Section</div><p>If you are using QtVCP to make a CNC control screen, under the <em>INI file</em> <code>[DISPLAY]</code> heading, set:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">DISPLAY </span></span><span style="font-weight: bold"><span style="color: #000000">=</span></span><span style="color: #009900"> qtvcp &lt;screen_name&gt;</span></tt></pre></div></div>
<div class="paragraph"><p><code>&lt;screen_name&gt;</code> is the <em>base name</em> of the <code>.ui</code> and <code>_handler.py</code> files.</p></div>
<div class="paragraph"><p>In our example there is already a sim configuration called tester, that we will use to display our test screen.</p></div>
<div class="paragraph"><div class="title">[HAL] Section</div><p>If your screen used <em>widgets with HAL pins</em>, then you must <strong>connect them in a HAL file</strong>.</p></div>
<div class="paragraph"><p>QtVCP looks in the <em>INI file</em>, under the <code>[HAL]</code> heading for the entries below:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong><code>POSTGUI_HALFILE=&lt;filename&gt;</code></strong>
</dt>
<dd>
<p>
  Typically <code>&lt;filename&gt;</code> would be <code>+&lt;screen_name&gt;_postgui.hal+</code>, but can be any legal filename.<br />
  You can have <em>multiple <code>POSTGUI_HALFILE</code> lines</em> in the INI: each will be run one after the other in the order they appear.<br />
  These commands are <em>executed after the screen is built</em>, guaranteeing the widget HAL pins are available.
</p>
</dd>
<dt class="hdlist1">
<strong><code>POSTGUI_HALCMD=&lt;command&gt;</code></strong>
</dt>
<dd>
<p>
  <code>&lt;command&gt;</code> would be <em>any valid HAL command</em>.<br />
  You can have <em>multiple <code>POSTGUI_HALCMD</code> lines</em> in the INI: each will be run one after the other in the order they appear.<br />
  To guaranty the widget HAL pins are available, these commands are executed:
</p>
<div class="ulist"><ul>
<li>
<p>
<em>after the screen is built</em>,
</p>
</li>
<li>
<p>
<em>after all the POSTGUI_HALFILEs are run</em>.
</p>
</li>
</ul></div>
</dd>
</dl></div>
<div class="paragraph"><p>In our example there are no HAL pins to connect.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_handler_file_in_detail">5. Handler File In Detail</h2>
<div class="sectionbody">
<div class="paragraph"><p>Handler files are used to <em>create custom controls using Python</em>.</p></div>
<div class="sect2">
<h3 id="_overview_2">5.1. Overview</h3>
<div class="paragraph"><p>Here is a sample handler file.</p></div>
<div class="paragraph"><p>It&#8217;s broken up in sections for ease of discussion.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">############################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># **** IMPORT SECTION **** #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">############################</span></span>
<span style="font-weight: bold"><span style="color: #000080">import</span></span> sys
<span style="font-weight: bold"><span style="color: #000080">import</span></span> os
<span style="font-weight: bold"><span style="color: #000080">import</span></span> linuxcnc

<span style="font-weight: bold"><span style="color: #000080">from</span></span> PyQt5 <span style="font-weight: bold"><span style="color: #000080">import</span></span> QtCore<span style="color: #990000">,</span> QtWidgets

<span style="font-weight: bold"><span style="color: #000080">from</span></span> qtvcp<span style="color: #990000">.</span>widgets<span style="color: #990000">.</span>mdi_line <span style="font-weight: bold"><span style="color: #000080">import</span></span> MDILine as MDI_WIDGET
<span style="font-weight: bold"><span style="color: #000080">from</span></span> qtvcp<span style="color: #990000">.</span>widgets<span style="color: #990000">.</span>gcode_editor <span style="font-weight: bold"><span style="color: #000080">import</span></span> GcodeEditor as GCODE
<span style="font-weight: bold"><span style="color: #000080">from</span></span> qtvcp<span style="color: #990000">.</span>lib<span style="color: #990000">.</span>keybindings <span style="font-weight: bold"><span style="color: #000080">import</span></span> Keylookup
<span style="font-weight: bold"><span style="color: #000080">from</span></span> qtvcp<span style="color: #990000">.</span>core <span style="font-weight: bold"><span style="color: #000080">import</span></span> Status<span style="color: #990000">,</span> Action

<span style="font-style: italic"><span style="color: #9A1900"># Set up logging</span></span>
<span style="font-weight: bold"><span style="color: #000080">from</span></span> qtvcp <span style="font-weight: bold"><span style="color: #000080">import</span></span> logger
LOG <span style="color: #990000">=</span> logger<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getLogger</span></span><span style="color: #990000">(</span>__name__<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900"># Set the log level for this module</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#LOG.setLevel(logger.INFO) # One of DEBUG, INFO, WARNING, ERROR, CRITICAL</span></span>

<span style="font-style: italic"><span style="color: #9A1900">###########################################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># **** INSTANTIATE LIBRARIES SECTION **** #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">###########################################</span></span>

KEYBIND <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Keylookup</span></span><span style="color: #990000">()</span>
STATUS <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Status</span></span><span style="color: #990000">()</span>
ACTION <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Action</span></span><span style="color: #990000">()</span>
<span style="font-style: italic"><span style="color: #9A1900">###################################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># **** HANDLER CLASS SECTION **** #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">###################################</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">class</span></span> HandlerClass<span style="color: #990000">:</span>

    <span style="font-style: italic"><span style="color: #9A1900">########################</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># **** INITIALIZE **** #</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">########################</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># widgets allows access to  widgets from the QtVCP files</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># at this point the widgets and hal pins are not instantiated</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">__init__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> halcomp<span style="color: #990000">,</span>widgets<span style="color: #990000">,</span>paths<span style="color: #990000">):</span>
        self<span style="color: #990000">.</span>hal <span style="color: #990000">=</span> halcomp
        self<span style="color: #990000">.</span>w <span style="color: #990000">=</span> widgets
        self<span style="color: #990000">.</span>PATHS <span style="color: #990000">=</span> paths

    <span style="font-style: italic"><span style="color: #9A1900">##########################################</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># SPECIAL FUNCTIONS SECTION              #</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">##########################################</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># at this point:</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># the widgets are instantiated.</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># the HAL pins are built but HAL is not set ready</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># This is where you make HAL pins or initialize state of widgets etc</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">initialized__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">pass</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">processed_key_event__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>receiver<span style="color: #990000">,</span>event<span style="color: #990000">,</span>is_pressed<span style="color: #990000">,</span>key<span style="color: #990000">,</span>code<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">):</span>
        <span style="font-style: italic"><span style="color: #9A1900"># when typing in MDI, we don't want keybinding to call functions</span></span>
        <span style="font-style: italic"><span style="color: #9A1900"># so we catch and process the events directly.</span></span>
        <span style="font-style: italic"><span style="color: #9A1900"># We do want ESC, F1 and F2 to call keybinding functions though</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> code <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span><span style="color: #990000">(</span>QtCore<span style="color: #990000">.</span>Qt<span style="color: #990000">.</span>Key_Escape<span style="color: #990000">,</span>QtCore<span style="color: #990000">.</span>Qt<span style="color: #990000">.</span>Key_F1 <span style="color: #990000">,</span>QtCore<span style="color: #990000">.</span>Qt<span style="color: #990000">.</span>Key_F2<span style="color: #990000">,</span>
                    QtCore<span style="color: #990000">.</span>Qt<span style="color: #990000">.</span>Key_F3<span style="color: #990000">,</span>QtCore<span style="color: #990000">.</span>Qt<span style="color: #990000">.</span>Key_F5<span style="color: #990000">,</span>QtCore<span style="color: #990000">.</span>Qt<span style="color: #990000">.</span>Key_F5<span style="color: #990000">):</span>

            <span style="font-style: italic"><span style="color: #9A1900"># search for the top widget of whatever widget received the event</span></span>
            <span style="font-style: italic"><span style="color: #9A1900"># then check if it's one we want the keypress events to go to</span></span>
            flag <span style="color: #990000">=</span> False
            receiver2 <span style="color: #990000">=</span> receiver
            <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> receiver2 <span style="font-weight: bold"><span style="color: #0000FF">is</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> None <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> flag<span style="color: #990000">:</span>
                <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #000000">isinstance</span></span><span style="color: #990000">(</span>receiver2<span style="color: #990000">,</span> QtWidgets<span style="color: #990000">.</span>QDialog<span style="color: #990000">):</span>
                    flag <span style="color: #990000">=</span> True
                    <span style="font-weight: bold"><span style="color: #0000FF">break</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #000000">isinstance</span></span><span style="color: #990000">(</span>receiver2<span style="color: #990000">,</span> MDI_WIDGET<span style="color: #990000">):</span>
                    flag <span style="color: #990000">=</span> True
                    <span style="font-weight: bold"><span style="color: #0000FF">break</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #000000">isinstance</span></span><span style="color: #990000">(</span>receiver2<span style="color: #990000">,</span> GCODE<span style="color: #990000">):</span>
                    flag <span style="color: #990000">=</span> True
                    <span style="font-weight: bold"><span style="color: #0000FF">break</span></span>
                receiver2 <span style="color: #990000">=</span> receiver2<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parent</span></span><span style="color: #990000">()</span>

            <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> flag<span style="color: #990000">:</span>
                <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #000000">isinstance</span></span><span style="color: #990000">(</span>receiver2<span style="color: #990000">,</span> GCODE<span style="color: #990000">):</span>
                    <span style="font-style: italic"><span style="color: #9A1900"># if in manual do our keybindings - otherwise</span></span>
                    <span style="font-style: italic"><span style="color: #9A1900"># send events to G-code widget</span></span>
                    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> STATUS<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">is_man_mode</span></span><span style="color: #990000">()</span> <span style="color: #990000">==</span> False<span style="color: #990000">:</span>
                        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> is_pressed<span style="color: #990000">:</span>
                            receiver<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">keyPressEvent</span></span><span style="color: #990000">(</span>event<span style="color: #990000">)</span>
                            event<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">accept</span></span><span style="color: #990000">()</span>
                        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> True
                <span style="font-weight: bold"><span style="color: #0000FF">elif</span></span> is_pressed<span style="color: #990000">:</span>
                    receiver<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">keyPressEvent</span></span><span style="color: #990000">(</span>event<span style="color: #990000">)</span>
                    event<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">accept</span></span><span style="color: #990000">()</span>
                    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> True
                <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
                    event<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">accept</span></span><span style="color: #990000">()</span>
                    <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> True

        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> event<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">isAutoRepeat</span></span><span style="color: #990000">():</span><span style="font-weight: bold"><span style="color: #0000FF">return</span></span> True

        <span style="font-style: italic"><span style="color: #9A1900"># ok if we got here then try keybindings</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">try</span></span><span style="color: #990000">:</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> KEYBIND<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">call</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>event<span style="color: #990000">,</span>is_pressed<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #0000FF">except</span></span> NameError as e<span style="color: #990000">:</span>
            LOG<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">debug</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Exception in KEYBINDING: {}'</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span> <span style="color: #990000">(</span>e<span style="color: #990000">))</span>
        <span style="font-weight: bold"><span style="color: #0000FF">except</span></span> Exception as e<span style="color: #990000">:</span>
            LOG<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">debug</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Exception in KEYBINDING:'</span><span style="color: #990000">,</span> exc_info<span style="color: #990000">=</span>e<span style="color: #990000">)</span>
            <span style="font-weight: bold"><span style="color: #0000FF">print</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Error in, or no function for: %s in handler file for-%s'</span><span style="color: #990000">%(</span>KEYBIND<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">convert</span></span><span style="color: #990000">(</span>event<span style="color: #990000">),</span>key<span style="color: #990000">))</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> False

    <span style="font-style: italic"><span style="color: #9A1900">########################</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># CALLBACKS FROM STATUS #</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">########################</span></span>

    <span style="font-style: italic"><span style="color: #9A1900">#######################</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># CALLBACKS FROM FORM #</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">#######################</span></span>

    <span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># GENERAL FUNCTIONS #</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># keyboard jogging from key binding calls</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># double the rate if fast is true</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">kb_jog</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> state<span style="color: #990000">,</span> joint<span style="color: #990000">,</span> direction<span style="color: #990000">,</span> fast <span style="color: #990000">=</span> False<span style="color: #990000">,</span> linear <span style="color: #990000">=</span> True<span style="color: #990000">):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> STATUS<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">is_man_mode</span></span><span style="color: #990000">()</span> <span style="font-weight: bold"><span style="color: #0000FF">or</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> STATUS<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">machine_is_on</span></span><span style="color: #990000">():</span>
            <span style="font-weight: bold"><span style="color: #0000FF">return</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> linear<span style="color: #990000">:</span>
            distance <span style="color: #990000">=</span> STATUS<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get_jog_increment</span></span><span style="color: #990000">()</span>
            rate <span style="color: #990000">=</span> STATUS<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get_jograte</span></span><span style="color: #990000">()/</span><span style="color: #993399">60</span>
        <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
            distance <span style="color: #990000">=</span> STATUS<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get_jog_increment_angular</span></span><span style="color: #990000">()</span>
            rate <span style="color: #990000">=</span> STATUS<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get_jograte_angular</span></span><span style="color: #990000">()/</span><span style="color: #993399">60</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> state<span style="color: #990000">:</span>
            <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> fast<span style="color: #990000">:</span>
                rate <span style="color: #990000">=</span> rate <span style="color: #990000">*</span> <span style="color: #993399">2</span>
            ACTION<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">JOG</span></span><span style="color: #990000">(</span>joint<span style="color: #990000">,</span> direction<span style="color: #990000">,</span> rate<span style="color: #990000">,</span> distance<span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
            ACTION<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">JOG</span></span><span style="color: #990000">(</span>joint<span style="color: #990000">,</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> <span style="color: #993399">0</span><span style="color: #990000">)</span>

    <span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># KEY BINDING CALLS #</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># Machine control</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">on_keycall_ESTOP</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>event<span style="color: #990000">,</span>state<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> state<span style="color: #990000">:</span>
            ACTION<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">SET_ESTOP_STATE</span></span><span style="color: #990000">(</span>STATUS<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">estop_is_clear</span></span><span style="color: #990000">())</span>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">on_keycall_POWER</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>event<span style="color: #990000">,</span>state<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> state<span style="color: #990000">:</span>
            ACTION<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">SET_MACHINE_STATE</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">not</span></span> STATUS<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">machine_is_on</span></span><span style="color: #990000">())</span>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">on_keycall_HOME</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>event<span style="color: #990000">,</span>state<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> state<span style="color: #990000">:</span>
            <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> STATUS<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">is_all_homed</span></span><span style="color: #990000">():</span>
                ACTION<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">SET_MACHINE_UNHOMED</span></span><span style="color: #990000">(-</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
            <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
                ACTION<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">SET_MACHINE_HOMING</span></span><span style="color: #990000">(-</span><span style="color: #993399">1</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">on_keycall_ABORT</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>event<span style="color: #990000">,</span>state<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> state<span style="color: #990000">:</span>
            <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> STATUS<span style="color: #990000">.</span>stat<span style="color: #990000">.</span>interp_state <span style="color: #990000">==</span> linuxcnc<span style="color: #990000">.</span>INTERP_IDLE<span style="color: #990000">:</span>
                self<span style="color: #990000">.</span>w<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">close</span></span><span style="color: #990000">()</span>
            <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
                self<span style="color: #990000">.</span>cmnd<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">abort</span></span><span style="color: #990000">()</span>

    <span style="font-style: italic"><span style="color: #9A1900"># Linear Jogging</span></span>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">on_keycall_XPOS</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>event<span style="color: #990000">,</span>state<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">):</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">kb_jog</span></span><span style="color: #990000">(</span>state<span style="color: #990000">,</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> shift<span style="color: #990000">)</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">on_keycall_XNEG</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>event<span style="color: #990000">,</span>state<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">):</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">kb_jog</span></span><span style="color: #990000">(</span>state<span style="color: #990000">,</span> <span style="color: #993399">0</span><span style="color: #990000">,</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">,</span> shift<span style="color: #990000">)</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">on_keycall_YPOS</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>event<span style="color: #990000">,</span>state<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">):</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">kb_jog</span></span><span style="color: #990000">(</span>state<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> shift<span style="color: #990000">)</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">on_keycall_YNEG</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>event<span style="color: #990000">,</span>state<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">):</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">kb_jog</span></span><span style="color: #990000">(</span>state<span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">,</span> shift<span style="color: #990000">)</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">on_keycall_ZPOS</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>event<span style="color: #990000">,</span>state<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">):</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">kb_jog</span></span><span style="color: #990000">(</span>state<span style="color: #990000">,</span> <span style="color: #993399">2</span><span style="color: #990000">,</span> <span style="color: #993399">1</span><span style="color: #990000">,</span> shift<span style="color: #990000">)</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">on_keycall_ZNEG</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>event<span style="color: #990000">,</span>state<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">):</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">kb_jog</span></span><span style="color: #990000">(</span>state<span style="color: #990000">,</span> <span style="color: #993399">2</span><span style="color: #990000">,</span> <span style="color: #990000">-</span><span style="color: #993399">1</span><span style="color: #990000">,</span> shift<span style="color: #990000">)</span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">on_keycall_APOS</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>event<span style="color: #990000">,</span>state<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">pass</span></span>
        <span style="font-style: italic"><span style="color: #9A1900">#self.kb_jog(state, 3, 1, shift, False)</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">on_keycall_ANEG</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>event<span style="color: #990000">,</span>state<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">pass</span></span>
        <span style="font-style: italic"><span style="color: #9A1900">#self.kb_jog(state, 3, -1, shift, linear=False)</span></span>

    <span style="font-style: italic"><span style="color: #9A1900">###########################</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># **** closing event **** #</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">###########################</span></span>

    <span style="font-style: italic"><span style="color: #9A1900">##############################</span></span>
    <span style="font-style: italic"><span style="color: #9A1900"># required class boiler code #</span></span>
    <span style="font-style: italic"><span style="color: #9A1900">##############################</span></span>

    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">__getitem__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> item<span style="color: #990000">):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">getattr</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> item<span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">__setitem__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> item<span style="color: #990000">,</span> value<span style="color: #990000">):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="font-weight: bold"><span style="color: #000000">setattr</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> item<span style="color: #990000">,</span> value<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">################################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># required handler boiler code #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">################################</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">get_handlers</span></span><span style="color: #990000">(</span>halcomp<span style="color: #990000">,</span>widgets<span style="color: #990000">,</span>paths<span style="color: #990000">):</span>
     <span style="font-weight: bold"><span style="color: #0000FF">return</span></span> <span style="color: #990000">[</span><span style="font-weight: bold"><span style="color: #000000">HandlerClass</span></span><span style="color: #990000">(</span>halcomp<span style="color: #990000">,</span>widgets<span style="color: #990000">,</span>paths<span style="color: #990000">)]</span></tt></pre></div></div>
</div>
<div class="sect2">
<h3 id="_import_section">5.2. IMPORT Section</h3>
<div class="paragraph"><p>This section is for <strong>importing required library modules</strong> for your screen.</p></div>
<div class="paragraph"><p>It would be typical to import QtVCP&#8217;s <em>keybinding</em>, <em>Status</em> and <em>Action</em> libraries.</p></div>
</div>
<div class="sect2">
<h3 id="_instantiate_libraries_section">5.3. INSTANTIATE LIBRARIES Section</h3>
<div class="paragraph"><p>By instantiating the libraries here we <strong>create global reference</strong>.</p></div>
<div class="paragraph"><p>You can note this by the commands that don&#8217;t have <code>self.</code> in front of them.</p></div>
<div class="paragraph"><p>By convention we <em>capitalize the names of globally referenced libraries</em>.</p></div>
</div>
<div class="sect2">
<h3 id="_handler_class_section">5.4. HANDLER CLASS Section</h3>
<div class="paragraph"><p>The <strong>custom code</strong> is placed <em>in a class so QtVCP can utilize it</em>.</p></div>
<div class="paragraph"><p>This is the definitions of the handler class.</p></div>
</div>
<div class="sect2">
<h3 id="_initialize_section">5.5. INITIALIZE Section</h3>
<div class="paragraph"><p>Like all Python libraries the <strong><code>+__init__+</code> function</strong> is called when the library is <em>first instantiated</em>.</p></div>
<div class="paragraph"><p>This is where you would set up <em>defaults</em>, as well as <em>reference variables</em> and <em>global variables</em>.</p></div>
<div class="paragraph"><p>The widget references are not available at this point.</p></div>
<div class="paragraph"><p>The variables <code>halcomp</code>, <code>widgets</code> and <code>paths</code> give access to QtVCP&#8217;s HAL component, widgets, and path info respectively.</p></div>
</div>
<div class="sect2">
<h3 id="_special_functions_section">5.6. SPECIAL FUNCTIONS Section</h3>
<div class="paragraph"><p>There are several <em>special functions</em> that QtVCP looks for in the handler file.</p></div>
<div class="paragraph"><p>If QtVCP finds these it will call them, if not it will silently ignore them.</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong><code>initialized__(self):</code></strong>
</dt>
<dd>
<p>
  This function is <em>called after the widgets and HAL pins are built</em>.<br />
  You can manipulate the widgets and HAL pins or add more HAL pins here.<br />
  Typically there can be
</p>
<div class="ulist"><ul>
<li>
<p>
preferences checked and set,
</p>
</li>
<li>
<p>
styles applied to widgets,
</p>
</li>
<li>
<p>
status of LinuxCNC connected to functions.
</p>
</li>
<li>
<p>
keybindings would be added.
</p>
</li>
</ul></div>
</dd>
<dt class="hdlist1">
<strong><code>class_patch__(self):</code></strong>
</dt>
<dd>
<p>
  <em>Class patching</em>, also known as <em>monkey patching</em>, allows to <strong>override function calls in an imported module</strong>.<br />
  Class patching must be done <em>before the module is instantiated</em>, and it <em>modifies all instances</em> made after that.<br />
  An example might be patching button calls from the G-code editor to call functions in the handler file instead.<br />
</p>
</dd>
<dt class="hdlist1">
<strong><code>processed_key_event__(self,receiver,event,is_pressed,key,code,shift,cntrl):</code></strong>
</dt>
<dd>
<p>
  This function is called to facilitate <em>keyboard jogging</em> etc.<br />
  By using the <em><code>keybinding</code> library</em> this can be used to easily add functions bound to keypresses.
</p>
</dd>
<dt class="hdlist1">
<strong><code>keypress_event__(self,receiver, event):</code></strong>
</dt>
<dd>
<p>
  This function gives <strong>raw key press events</strong>.<br />
  It takes <em>precedence over</em> the <code>processed_key_event</code>.
</p>
</dd>
<dt class="hdlist1">
<strong><code>keyrelease_event__(receiver, event):</code></strong>
</dt>
<dd>
<p>
  This function gives <strong>raw key release events</strong>.<br />
  It takes <em>precedence over</em> the <code>processed_key_event</code>.
</p>
</dd>
<dt class="hdlist1">
<strong><code>before_loop__(self):</code></strong>
</dt>
<dd>
<p>
  This function is <em>called just before the Qt event loop is entered</em>.
  At that point, all widgets/libraries/initialization code has completed and the screen is already displayed.
</p>
</dd>
<dt class="hdlist1">
<strong><code>system_shutdown_request__(self):</code></strong>
</dt>
<dd>
<p>
  If present, this function <strong>overrides the normal function called for total system shutdown</strong>.<br />
  It could be used to do <em>pre-shutdown housekeeping</em>.<br />
 <br />
  The Linux <em>system will not shutdown if using this function</em>, you will have to do that yourself.<br />
  QtVCP/LinuxCNC will terminate without a prompt once this function returns.
</p>
</dd>
<dt class="hdlist1">
<strong><code>closing_cleanup__(self):</code></strong>
</dt>
<dd>
<p>
  This function is <em>called just before the screen closes</em>.
  It can be used to do cleanup before closing.
</p>
</dd>
</dl></div>
</div>
<div class="sect2">
<h3 id="_status_callbacks_section">5.7. STATUS CALLBACKS Section</h3>
<div class="paragraph"><p>By convention this is where you would put functions that are <strong>callbacks from STATUS definitions</strong>.</p></div>
</div>
<div class="sect2">
<h3 id="_callbacks_from_form_section">5.8. CALLBACKS FROM FORM Section</h3>
<div class="paragraph"><p>By convention this is where you would put functions that are <strong>callbacks from the widgets connected to the MainWindow</strong> in the Qt Designer editor.</p></div>
</div>
<div class="sect2">
<h3 id="_general_functions_section">5.9. GENERAL FUNCTIONS Section</h3>
<div class="paragraph"><p>By convention this is where you put your <strong>general functions</strong>.</p></div>
</div>
<div class="sect2">
<h3 id="_key_binding_section">5.10. KEY BINDING Section</h3>
<div class="paragraph"><p>If you are <em>using the <code>keybinding</code> library</em> this is where you place your <strong>custom key call routines</strong>.</p></div>
<div class="paragraph"><p>The function signature is:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">on_keycall_KEY</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>event<span style="color: #990000">,</span>state<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> state<span style="color: #990000">:</span>
        self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">do_something_function</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><p><code>KEY</code> being the code (from the keybindings library) for the desired key.</p></div>
</div>
<div class="sect2">
<h3 id="_closing_event_section">5.11. CLOSING EVENT Section</h3>
<div class="paragraph"><p>Putting the <strong><code>closeEvent</code> function here will catch closing events</strong>.</p></div>
<div class="paragraph"><p>This <em>replaces any predefined <code>closeEvent</code></em> function from QtVCP.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">closeEvent</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> event<span style="color: #990000">):</span>
    self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">do_something</span></span><span style="color: #990000">()</span>
    event<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">accept</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">It is usually better to use the special <code>closing_cleanup__</code> function.</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_connecting_widgets_to_python_code">6. Connecting Widgets to Python Code</h2>
<div class="sectionbody">
<div class="paragraph"><p>It is possible to connect widgets to Python code using <strong>signals and slots</strong>.</p></div>
<div class="paragraph"><p>In this way you can:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Give new functions to LinuxCNC widgets</em>, or
</p>
</li>
<li>
<p>
<em>Utilize standard Qt widgets to control LinuxCNC</em>.
</p>
</li>
</ul></div>
<div class="sect2">
<h3 id="_overview_3">6.1. Overview</h3>
<div class="paragraph"><p><strong>In the Qt Designer editor</strong>:</p></div>
<div class="ulist"><ul>
<li>
<p>
You <em>create user function slots</em>
</p>
</li>
<li>
<p>
You <em>connect the slots to widgets using signals</em>.
</p>
</li>
</ul></div>
<div class="paragraph"><p><strong>In the handler file</strong>:</p></div>
<div class="ulist"><ul>
<li>
<p>
You <em>create the slot&#8217;s functions</em> defined in Qt Designer.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="sub:qtvcp:designer-slots">6.2. Using Qt Designer to add Slots</h3>
<div class="paragraph"><p>When you have loaded your screen into Qt Designer, add a plain <code>PushButton</code> to the screen.<br />
You could change the name of the button to something interesting like <em>test_button</em>.</p></div>
<div class="paragraph"><p>There are two ways to edit connections - This is the graphical way.</p></div>
<div class="ulist"><ul>
<li>
<p>
There is a button in the top tool bar of Qt Designer for editing signals.
  After pushing it, if you click-and-hold on the button it will show an arrow (looks like a ground signal from electrical schematic).
</p>
</li>
<li>
<p>
Slide this arrow to a part of the main window that does not have widgets on it.
</p>
</li>
<li>
<p>
A <em>Configure Connections</em> dialog will pop up.
</p>
<div class="ulist"><ul>
<li>
<p>
The list on the left are the available signals from the widget.
</p>
</li>
<li>
<p>
The list on the right are the available slots on the main window and you can add to it.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Pick the signal <code>clicked()</code> - this makes the slots side available.
</p>
</li>
<li>
<p>
Click <em>Edit</em> on the slots list.
</p>
</li>
<li>
<p>
A <em>Slots/Signals of MainWindow</em> dialog will pop up.
</p>
</li>
<li>
<p>
On the slots list at the top there is a <em>+</em> icon - click it.
</p>
</li>
<li>
<p>
You can now edit a new slot name.
</p>
</li>
<li>
<p>
Erase the default name <code>slot()</code> and change it to <code>test_button()</code>
</p>
</li>
<li>
<p>
Press the <em>OK</em> button.
</p>
</li>
<li>
<p>
You&#8217;ll be back to the <em>Configure Connections</em> dialog.
</p>
</li>
<li>
<p>
Now you can select your new slot in the slot list.
</p>
</li>
<li>
<p>
Then press <em>OK</em> and save the file.
</p>
</li>
</ul></div>
<div class="imageblock" style="text-align:center;">
<div class="content">
<figure>
<img src="images/designer_slots.png" alt="Qt Designer Signal/Slot Selection"/>
<figcaption class="title"> Figure 14. Qt Designer Signal/Slot Selection</figcaption>
</figure>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_python_handler_changes">6.3. Python Handler Changes</h3>
<div class="paragraph"><p>Now you must <strong>add the function to the handler file</strong>.</p></div>
<div class="paragraph"><p>The function signature is <strong><code>def slot_name(self):</code></strong>.</p></div>
<div class="paragraph"><p>For our example, we will add some code to print the widget name:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_button</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
    name <span style="color: #990000">=</span> self<span style="color: #990000">.</span>w<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">sender</span></span><span style="color: #990000">().</span><span style="font-weight: bold"><span style="color: #000000">text</span></span><span style="color: #990000">()</span>
    <span style="font-weight: bold"><span style="color: #0000FF">print</span></span><span style="color: #990000">(</span>name<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Add this code under the section named:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">#######################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># callbacks from form #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#######################</span></span></tt></pre></div></div>
<div class="paragraph"><p>In fact it doesn&#8217;t matter where in the handler class you put the commands but by convention this is where to put it.</p></div>
<div class="paragraph"><p>Save the handler file.</p></div>
<div class="paragraph"><p>Now when you load your screen and press the button it should print the name of the button in the terminal.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_more_information">7. More Information</h2>
<div class="sectionbody">
<div class="paragraph"><p><a href="qtvcp-vcp-panels.html#cha:qtvcp:panels">QtVCP Builtin Virtual Control Panels</a></p></div>
<div class="paragraph"><p><a href="qtvcp-widgets.html#cha:qtvcp:widgets">QtVCP Widgets</a></p></div>
<div class="paragraph"><p><a href="qtvcp-libraries.html#cha:qtvcp:libraries">QtVCP Libraries</a></p></div>
<div class="paragraph"><p><a href="qtvcp-vismach.html#cha:qtvcp:vismach">Qt Vismach</a></p></div>
<div class="paragraph"><p><a href="qtvcp-code-snippets.html#cha:qtvcp:code">QtVCP Handler File Code Snippets</a></p></div>
<div class="paragraph"><p><a href="qtvcp-development.html#cha:qtvcp:devel">QtVCP Development</a></p></div>
<div class="paragraph"><p><a href="qtvcp-custom-widgets.html#cha:qtvcp:custom-widgets">QtVCP Custom Qt Designer Widgets</a></p></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2023-06-17 21:52:11 CEST
</div>
</div>
</body>
</html>
