<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 9.0.0rc2" />
<title>QtVCP Handler File Code Snippets</title>
<link rel="stylesheet" href="..//asciidoc.css" type="text/css" />


<link rel="stylesheet" href="..//linuxcnc.css" type="text/css" />
<script type="text/javascript" src="..//asciidoc.js"></script>
<script type="text/javascript">
/*<![CDATA[*/
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="book">
<div id="header">
<h1>QtVCP Handler File Code Snippets</h1>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="cha:qtvcp:code">1. Preference File Loading/Saving</h2>
<div class="sectionbody">
<div class="paragraph"><p>Here is how to <strong>load and save preferences at launch and closing time</strong>.</p></div>
<div class="ulist"><div class="title">Prerequisites</div><ul>
<li>
<p>
<em>Preference file option must be set</em> in the <code>ScreenOptions</code> widget.
</p>
</li>
<li>
<p>
<em>Preference file path must be set</em> in the <code>INI</code> configuration.
</p>
</li>
</ul></div>
<div class="paragraph"><div class="title">Reading preferences at launch time</div><p>Under the <strong><code>def initialized__(self):</code></strong> function add:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>PREFS_<span style="color: #990000">:</span>
    <span style="font-style: italic"><span style="color: #9A1900"># variable name (entry name, default value, type, section name)</span></span>
    self<span style="color: #990000">.</span>int_value <span style="color: #990000">=</span> self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>PREFS_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getpref</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Integer_value'</span><span style="color: #990000">,</span> <span style="color: #993399">75</span><span style="color: #990000">,</span> int<span style="color: #990000">,</span> <span style="color: #FF0000">'CUSTOM_FORM_ENTRIES'</span><span style="color: #990000">)</span>
    self<span style="color: #990000">.</span>string_value <span style="color: #990000">=</span> self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>PREFS_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getpref</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'String_value'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'on'</span><span style="color: #990000">,</span> str<span style="color: #990000">,</span> <span style="color: #FF0000">'CUSTOM_FORM_ENTRIES'</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><div class="title">Writing preferences at close time</div><p>In the <strong><code>closing_cleanup__()</code></strong> function, add:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">if</span></span> self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>PREFS_<span style="color: #990000">:</span>
    <span style="font-style: italic"><span style="color: #9A1900"># variable name (entry name, variable name, type, section name)</span></span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>PREFS_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">putpref</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Integer_value'</span><span style="color: #990000">,</span> self<span style="color: #990000">.</span>integer_value<span style="color: #990000">,</span> int<span style="color: #990000">,</span> <span style="color: #FF0000">'CUSTOM_FORM_ENTRIES'</span><span style="color: #990000">)</span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>PREFS_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">putpref</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'String_value'</span><span style="color: #990000">,</span> self<span style="color: #990000">.</span>string_value<span style="color: #990000">,</span> str<span style="color: #990000">,</span> <span style="color: #FF0000">'CUSTOM_FORM_ENTRIES'</span><span style="color: #990000">)</span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_use_code_qsettings_code_to_read_save_variables">2. Use <code>QSettings</code> To Read/Save Variables</h2>
<div class="sectionbody">
<div class="paragraph"><p>Here is how to <strong>load and save variables using PyQt&#8217;s <code>QSettings</code></strong> functions:</p></div>
<div class="ulist"><div class="title">Good practices</div><ul>
<li>
<p>
<em>Use <code>Group</code> to keep names organized and unique</em>.
</p>
</li>
<li>
<p>
<em>Account for <code>none</code> value</em> returned when reading a setting which has no entry.
</p>
</li>
<li>
<p>
<em>Set defaults to cover the first time it is run</em> using the <code>or _&lt;default_value&gt;_</code> syntax.
</p>
</li>
</ul></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The file is actually saved in <code>~/.config/QtVcp</code></td>
</tr></table>
</div>
<div class="paragraph"><div class="title">Example</div><p>In this example:</p></div>
<div class="ulist"><ul>
<li>
<p>
We add <code>or 20</code> and <code>or 2.5</code> as defaults.
</p>
</li>
<li>
<p>
The names <code>MyGroupName</code>, <code>int_value</code>, <code>float_value</code>, <code>myInteger</code>, and <code>myFloat</code> are user defined.
</p>
</li>
<li>
<p>
Under the <strong><code>def initialized__(self):</code></strong> function add:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># set recorded columns sort settings</span></span>
self<span style="color: #990000">.</span>SETTINGS_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">beginGroup</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"MyGroupName"</span><span style="color: #990000">)</span>
self<span style="color: #990000">.</span>int_value <span style="color: #990000">=</span> self<span style="color: #990000">.</span>SETTINGS_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">value</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'myInteger'</span><span style="color: #990000">,</span> type <span style="color: #990000">=</span> int<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">or</span></span> <span style="color: #993399">20</span>
self<span style="color: #990000">.</span>float_value <span style="color: #990000">=</span> self<span style="color: #990000">.</span>SETTINGS_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">value</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'myFloat'</span><span style="color: #990000">,</span> type <span style="color: #990000">=</span> float<span style="color: #990000">)</span> <span style="font-weight: bold"><span style="color: #0000FF">or</span></span> <span style="color: #993399">2.5</span>
self<span style="color: #990000">.</span>SETTINGS_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">endGroup</span></span><span style="color: #990000">()</span></tt></pre></div></div>
</li>
<li>
<p>
Under the <strong><code>def closing_cleanup__(self):</code></strong> function add:
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># save values with QSettings</span></span>
self<span style="color: #990000">.</span>SETTINGS_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">beginGroup</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"MyGroupName"</span><span style="color: #990000">)</span>
self<span style="color: #990000">.</span>SETTINGS_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setValue</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'myInteger'</span><span style="color: #990000">,</span> self<span style="color: #990000">.</span>int_value<span style="color: #990000">)</span>
self<span style="color: #990000">.</span>SETTINGS_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setValue</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'myFloat'</span><span style="color: #990000">,</span> self<span style="color: #990000">.</span>float_value<span style="color: #990000">)</span>
self<span style="color: #990000">.</span>SETTINGS_<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">endGroup</span></span><span style="color: #990000">()</span></tt></pre></div></div>
</li>
</ul></div>
</div>
</div>
<div class="sect1">
<h2 id="_add_a_basic_style_editor">3. Add A Basic Style Editor</h2>
<div class="sectionbody">
<div class="paragraph"><p>Being able to <strong>edit a style on a running screen</strong> is convenient.</p></div>
<div class="listingblock">
<div class="title">Import <code>StyleSheetEditor</code> module in the <code>IMPORT SECTION</code>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> qtvcp<span style="color: #990000">.</span>widgets<span style="color: #990000">.</span>stylesheeteditor <span style="font-weight: bold"><span style="color: #000080">import</span></span> StyleSheetEditor as SSE</tt></pre></div></div>
<div class="listingblock">
<div class="title">Instantiate <code>StyleSheetEditor</code> module in the <code>INSTANTIATE SECTION</code>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>STYLEEDITOR <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">SSE</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><div class="title">Create a <code>keybinding</code> in the <code>INITIALIZE SECTION</code>:</div><p>Under the <code>+__init__.(self, halcomp, widgets, paths):+</code> function add:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>KEYBIND<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">add_call</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Key_F12'</span><span style="color: #990000">,</span><span style="color: #FF0000">'on_keycall_F12'</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">Create the key bound function in the <code>KEYBINDING SECTION</code>:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">on_keycall_F12</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>event<span style="color: #990000">,</span>state<span style="color: #990000">,</span>shift<span style="color: #990000">,</span>cntrl<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> state<span style="color: #990000">:</span>
        STYLEEDITOR<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">load_dialog</span></span><span style="color: #990000">()</span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_request_dialog_entry">4. Request Dialog Entry</h2>
<div class="sectionbody">
<div class="paragraph"><p>QtVCP uses <code>STATUS</code> messages to <strong>pop up and return information from dialogs</strong>.</p></div>
<div class="paragraph"><p>Prebuilt dialogs keep track of their last position and include options for focus shading and sound.</p></div>
<div class="paragraph"><p>To <em>get information back from the dialog</em> requires using a <code>STATUS</code> <strong><code>general</code></strong> message.</p></div>
<div class="listingblock">
<div class="title">Import and Instantiate the <code>Status</code> module in the <code>IMPORT SECTION</code></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> qtvcp<span style="color: #990000">.</span>core <span style="font-weight: bold"><span style="color: #000080">import</span></span> Status
STATUS <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Status</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><p>This loads and initializes the <code>Status</code> library.</p></div>
<div class="paragraph"><div class="title">Register function for <code>STATUS general</code> messages in the <em>INITIALIZE SECTION</em></div><p>Under the <code>+__init__.(self, halcomp, widgets, paths)+</code> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>STATUS<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">connect</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'general'</span><span style="color: #990000">,</span>self<span style="color: #990000">.</span>return_value<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This registers <code>STATUS</code> to call the function <code>self.return_value</code> when a
general message is sent.</p></div>
<div class="listingblock">
<div class="title">Add entry dialog request function in the <code>GENERAL FUNCTIONS</code> section</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">request_number</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
    mess <span style="color: #990000">=</span> <span style="color: #990000">{</span><span style="color: #FF0000">'NAME'</span><span style="color: #990000">:</span><span style="color: #FF0000">'ENTRY'</span><span style="color: #990000">,</span><span style="color: #FF0000">'ID'</span><span style="color: #990000">:</span><span style="color: #FF0000">'FORM__NUMBER'</span><span style="color: #990000">,</span> <span style="color: #FF0000">'TITLE'</span><span style="color: #990000">:</span><span style="color: #FF0000">'Set Tool Offset'</span><span style="color: #990000">}</span>
    STATUS<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">emit</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'dialog-request'</span><span style="color: #990000">,</span> mess<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>The function</p></div>
<div class="ulist"><ul>
<li>
<p>
creates a Python <code>dict</code> with:
</p>
<div class="ulist"><ul>
<li>
<p>
<strong><code>NAME</code></strong> - needs to be set to the <em>dialogs unique launch name</em>.<br />
   <code>NAME</code> sets which dialog to request.<br />
   <code>ENTRY</code> or <code>CALCULATOR</code> allows entering numbers.
</p>
</li>
<li>
<p>
<strong><code>ID</code></strong> - needs to be set to a <em>unique name that the function supplies</em>.
   <code>ID</code> should be a unique key.
</p>
</li>
<li>
<p>
<strong><code>TITLE</code></strong> sets the dialog title.
</p>
</li>
<li>
<p>
<strong>Arbitrary data</strong> can be added to the <code>dict</code>. The dialog will ignore them but send them back to the return code.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Sends the <code>dict</code> as a <strong><code>dialog-request</code></strong> <code>STATUS</code> message
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="title">Add message data processing function in the <code>CALLBACKS FROM STATUS</code> section.</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># Process the STATUS return message from set-tool-offset</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">return_value</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> w<span style="color: #990000">,</span> message<span style="color: #990000">):</span>
    num <span style="color: #990000">=</span> message<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'RETURN'</span><span style="color: #990000">)</span>
    id_code <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">bool</span></span><span style="color: #990000">(</span>message<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'ID'</span><span style="color: #990000">)</span> <span style="color: #990000">==</span> <span style="color: #FF0000">'FORM__NUMBER'</span><span style="color: #990000">)</span>
    name <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">bool</span></span><span style="color: #990000">(</span>message<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">get</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'NAME'</span><span style="color: #990000">)</span> <span style="color: #990000">==</span> <span style="color: #FF0000">'ENTRY'</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> id_code <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> name <span style="font-weight: bold"><span style="color: #0000FF">and</span></span> num <span style="font-weight: bold"><span style="color: #0000FF">is</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> None<span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">print</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'The {} number from {} was: {}'</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span>name<span style="color: #990000">,</span> id_code<span style="color: #990000">,</span> num<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>This catches all general messages so it must <em>check the dialog type and id code</em> to confirm it&#8217;s our dialog.
In this case we had requested an <code>ENTRY</code> dialog and our unique id was <code>FORM_NUMBER</code>, so now we know the message is for us.
<code>ENTRY</code> or <code>CALCULATOR</code> dialogs return a float number.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_speak_a_startup_greeting">5. Speak a Startup Greeting</h2>
<div class="sectionbody">
<div class="paragraph"><p>This requires the <code>espeak</code> library installed on the system.</p></div>
<div class="listingblock">
<div class="title">Import and instantiate the <code>Status</code> in the <code>IMPORT</code> section</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> qtvcp<span style="color: #990000">.</span>core <span style="font-weight: bold"><span style="color: #000080">import</span></span> Status
STATUS <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Status</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><div class="title">Emit spoken message in the <code>INITIALIZE SECTION</code></div><p>Under the <em><code><em>init</em>.(self, halcomp, widgets, paths)</code></em> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>STATUS<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">emit</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'play-alert'</span><span style="color: #990000">,</span><span style="color: #FF0000">'SPEAK Please remember to oil the ways.'</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p><strong><code>SPEAK</code></strong> is a keyword: <em>everything after it will be pronounced</em>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_toolbar_functions">6. ToolBar Functions</h2>
<div class="sectionbody">
<div class="paragraph"><p>Toolbar buttons and submenus are added in Qt Designer but the code to make them do something is added in the handler file.
To <strong>add a submenus</strong> in Qt Designer:</p></div>
<div class="ulist"><ul>
<li>
<p>
Add a <code>Qaction</code> by typing in the toolbar column then clicking the <em>+</em> icon on the right.
</p>
</li>
<li>
<p>
This will add a sub column that you need to type a name into.
</p>
</li>
<li>
<p>
Now the original <code>Qaction</code> will be a <code>Qmenu</code> instead.
</p>
</li>
<li>
<p>
Now erase the <code>Qaction</code> you added to that <code>Qmenu</code>, the menu will stay as a menu.
</p>
</li>
</ul></div>
<div class="paragraph"><p>In this example we assume you added a toolbar with one submenu and three actions.
These actions will be configured to create:</p></div>
<div class="ulist"><ul>
<li>
<p>
a recent file selection menu,
</p>
</li>
<li>
<p>
an about pop up dialog action,
</p>
</li>
<li>
<p>
a quit program action, and
</p>
</li>
<li>
<p>
a user defined function action.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The <code>objectName</code> of the toolbar button is used to identify the button when configuring it - <em>descriptive names help</em>.</p></div>
<div class="paragraph"><p>Using the action editor menu, right click and select edit.<br />
Edit the object name, text, and button type for an appropriate action.</p></div>
<div class="paragraph"><p>In this example the:</p></div>
<div class="ulist"><ul>
<li>
<p>
submenu name must be <code>menuRecent</code>,
</p>
</li>
<li>
<p>
actions names must be <code>actionAbout</code>, <code>actionQuit</code>, <code>actionMyFunction</code>
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="title">Loads the <code>toolbar_actions</code> library in the <code>IMPORT SECTION</code></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> qtvcp<span style="color: #990000">.</span>lib<span style="color: #990000">.</span>toolbar_actions <span style="font-weight: bold"><span style="color: #000080">import</span></span> ToolBarActions</tt></pre></div></div>
<div class="listingblock">
<div class="title">Instantiate <code>ToolBarActions</code> module in the <code>INSTANTIATE LIBRARY SECTION</code></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>TOOLBAR <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">ToolBarActions</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><div class="title">Configure submenus and actions in the <code>SPECIAL FUNCTIONS SECTION</code></div><p>Under the <code>def initialized__(self)</code> function add:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>TOOLBAR<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">configure_submenu</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>menuRecent<span style="color: #990000">,</span> <span style="color: #FF0000">'recent_submenu'</span><span style="color: #990000">)</span>
TOOLBAR<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">configure_action</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>actionAbout<span style="color: #990000">,</span> <span style="color: #FF0000">'about'</span><span style="color: #990000">)</span>
TOOLBAR<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">configure_action</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>actionQuit<span style="color: #990000">,</span> <span style="color: #FF0000">'Quit'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">lambda</span></span> d<span style="color: #990000">:</span>self<span style="color: #990000">.</span>w<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">close</span></span><span style="color: #990000">())</span>
TOOLBAR<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">configure_action</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>actionMyFunction<span style="color: #990000">,</span> <span style="color: #FF0000">'My Function'</span><span style="color: #990000">,</span> self<span style="color: #990000">.</span>my_function<span style="color: #990000">)</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">Define the user function in the <code>GENERAL FUNCTIONS SECTION</code></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">my_function</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> widget<span style="color: #990000">,</span> state<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">print</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'My function State = ()'</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span>state<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><p>The function to be called if the action "My Function" button is pressed.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_add_hal_pins_that_call_functions">7. Add HAL Pins That Call Functions</h2>
<div class="sectionbody">
<div class="paragraph"><p>In this way you <em>don&#8217;t need to poll the state of input pins</em>.</p></div>
<div class="listingblock">
<div class="title">Loads the <code>Qhal</code> library in the <code>IMPORT SECTION</code></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> qtvcp<span style="color: #990000">.</span>core <span style="font-weight: bold"><span style="color: #000080">import</span></span> Qhal</tt></pre></div></div>
<div class="paragraph"><p>This is to allow access to <strong>QtVCP&#8217;s HAL component</strong>.</p></div>
<div class="listingblock">
<div class="title">Instantiate <code>Qhal</code> in the <code>INSTANTIATE LIBRARY SECTION</code></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>QHAL <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Qhal</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><div class="title">Add a function that gets called when the pin state changes</div><p>Under the <code>initialised__</code> function, make sure there is an entry similar to this:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">##########################################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># Special Functions called from QtVCP</span></span>
<span style="font-style: italic"><span style="color: #9A1900">##########################################</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># at this point:</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># the widgets are instantiated.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># the HAL pins are built but HAL is not set ready</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">initialized__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
    self<span style="color: #990000">.</span>pin_cycle_start_in <span style="color: #990000">=</span> QHAL<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">newpin</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'cycle-start-in'</span><span style="color: #990000">,</span>QHAL<span style="color: #990000">.</span>HAL_BIT<span style="color: #990000">,</span> QHAL<span style="color: #990000">.</span>HAL_IN<span style="color: #990000">)</span>
    self<span style="color: #990000">.</span>pin_cycle_start_in<span style="color: #990000">.</span>value_changed<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">connect</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #0000FF">lambda</span></span> s<span style="color: #990000">:</span> self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">cycleStart</span></span><span style="color: #990000">(</span>s<span style="color: #990000">))</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">Define the function called by pin state change in the <code>GENERAL FUNCTIONS SECTION</code></div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># general functions #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">cycleStart</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> state<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> state<span style="color: #990000">:</span>
        tab <span style="color: #990000">=</span> self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>mainTab<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">currentWidget</span></span><span style="color: #990000">()</span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span>  tab <span style="font-weight: bold"><span style="color: #0000FF">in</span></span><span style="color: #990000">(</span> self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>tab_auto<span style="color: #990000">,</span>  self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>tab_graphics<span style="color: #990000">):</span>
            ACTION<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">RUN</span></span><span style="color: #990000">(</span>line<span style="color: #990000">=</span><span style="color: #993399">0</span><span style="color: #990000">)</span>
        <span style="font-weight: bold"><span style="color: #0000FF">elif</span></span> tab <span style="color: #990000">==</span> self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>tab_files<span style="color: #990000">:</span>
                self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>filemanager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">load</span></span><span style="color: #990000">()</span>
        <span style="font-weight: bold"><span style="color: #0000FF">elif</span></span> tab <span style="color: #990000">==</span> self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>tab_mdi<span style="color: #990000">:</span>
            self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>mditouchy<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">run_command</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><p>This function assumes there is a Tab widget, named <code>mainTab</code>,
that has tabs with the names <code>tab_auto</code>, <code>tab_graphics</code>, <code>tab_filemanager</code> and <code>tab_mdi</code>.</p></div>
<div class="paragraph"><p>In this way the cycle start button works differently depending on what tab is shown.</p></div>
<div class="paragraph"><p>This is simplified - <em>checking state and error trapping might be helpful</em>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_add_a_special_max_velocity_slider_based_on_percent">8. Add A Special Max Velocity Slider Based On Percent</h2>
<div class="sectionbody">
<div class="paragraph"><p>Some times you want to <strong>build a widget to do something not built in</strong>.
The built in Max velocity slider acts on units per minute, here we show how to do on percent.</p></div>
<div class="paragraph"><p>The <strong><code>STATUS</code></strong> command makes sure the slider adjusts if LinuxCNC changes the current max velocity.</p></div>
<div class="paragraph"><p><strong><code>valueChanged.connect()</code></strong> <em>calls a function when the slider is moved</em>.</p></div>
<div class="paragraph"><p>In Qt Designer add a <strong><code>QSlider</code></strong> widget called <code>mvPercent</code>, then add the following code to the handler file:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">#############################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># SPECIAL FUNCTIONS SECTION #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#############################</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">initialized__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>mvPercent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setMaximum</span></span><span style="color: #990000">(</span><span style="color: #993399">100</span><span style="color: #990000">)</span>
    STATUS<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">connect</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'max-velocity-override-changed'</span><span style="color: #990000">,</span> <span style="color: #990000">\</span>
        <span style="font-weight: bold"><span style="color: #0000FF">lambda</span></span> w<span style="color: #990000">,</span> data<span style="color: #990000">:</span> self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>mvPercent<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setValue</span></span><span style="color: #990000">(</span> <span style="color: #990000">\</span>
            <span style="color: #990000">(</span>data <span style="color: #990000">/</span> INFO<span style="color: #990000">.</span>MAX_TRAJ_VELOCITY<span style="color: #990000">)*</span><span style="color: #993399">100</span> <span style="color: #990000">\</span>
            <span style="color: #990000">)</span>
        <span style="color: #990000">)</span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>mvPercent<span style="color: #990000">.</span>valueChanged<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">connect</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>setMVPercentValue<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># GENERAL FUNCTIONS #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">setMVPercentValue</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> value<span style="color: #990000">):</span>
    ACTION<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">SET_MAX_VELOCITY_RATE</span></span><span style="color: #990000">(</span>INFO<span style="color: #990000">.</span>MAX_TRAJ_VELOCITY <span style="color: #990000">*</span> <span style="color: #990000">(</span>value<span style="color: #990000">/</span><span style="color: #993399">100.0</span><span style="color: #990000">))</span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_toggle_continuous_jog_on_and_off">9. Toggle Continuous Jog On and Off</h2>
<div class="sectionbody">
<div class="paragraph"><p>Generally selecting continuous jogging is a momentary button,
that requires you to select the previous jog increment after.</p></div>
<div class="paragraph"><p>We will build a button that toggles between continuous jog and whatever increment that was already selected.</p></div>
<div class="paragraph"><p>In Qt Designer:</p></div>
<div class="ulist"><ul>
<li>
<p>
Add an <code>ActionButton</code> with no action
</p>
</li>
<li>
<p>
Call it <code>btn_toggle_continuous</code>.
</p>
</li>
<li>
<p>
Set the <code>AbstractButton</code> property <code>checkable</code> to <code>True</code>.
</p>
</li>
<li>
<p>
Set the <code>ActionButton</code> properties <code>incr_imperial_number</code> and <code>incr_mm_number</code> to <code>0</code>.
</p>
</li>
<li>
<p>
Use Qt Designer&#8217;s slot editor to use the button signal <code>clicked(bool)</code> to call form&#8217;s handler function <code>toggle_continuous_clicked()</code>.<br />
  See <a href="qtvcp.html#sub:qtvcp:designer-slots">Using Qt Designer To Add Slots</a> section for more information.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Then add this code snippets to the handler file under the <code>initialized__</code> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># at this point:</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># the widgets are instantiated.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># the HAL pins are built but HAL is not set ready</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">initialized__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
    STATUS<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">connect</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'jogincrement-changed'</span><span style="color: #990000">,</span> <span style="color: #990000">\</span>
        <span style="font-weight: bold"><span style="color: #0000FF">lambda</span></span> w<span style="color: #990000">,</span> d<span style="color: #990000">,</span> t<span style="color: #990000">:</span> self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">record_jog_incr</span></span><span style="color: #990000">(</span>d<span style="color: #990000">,</span>t<span style="color: #990000">)</span> <span style="color: #990000">\</span>
        <span style="color: #990000">)</span>
    <span style="font-style: italic"><span style="color: #9A1900"># set a default increment to toggle back to</span></span>
    self<span style="color: #990000">.</span>L_incr <span style="color: #990000">=</span> <span style="color: #993399">0.01</span>
    self<span style="color: #990000">.</span>L_text <span style="color: #990000">=</span> <span style="color: #FF0000">"0.01in"</span></tt></pre></div></div>
<div class="paragraph"><p>In the <code>GENERAL FUNCTIONS SECTION</code> add:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># GENERAL FUNCTIONS #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># if it isn't continuous, record the latest jog increment</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># and untoggle the continuous button</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">record_jog_incr</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>d<span style="color: #990000">,</span> t<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> d <span style="color: #990000">!=</span> <span style="color: #993399">0</span><span style="color: #990000">:</span>
        self<span style="color: #990000">.</span>L_incr <span style="color: #990000">=</span> d
        self<span style="color: #990000">.</span>L_text <span style="color: #990000">=</span> t
        self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>btn_toggle_continuous<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">safecheck</span></span><span style="color: #990000">(</span>False<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>In the <code>CALLBACKS FROM FORM SECTION</code> add:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">#######################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># CALLBACKS FROM FORM #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#######################</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">toggle_continuous_clicked</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> state<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> state<span style="color: #990000">:</span>
        <span style="font-style: italic"><span style="color: #9A1900"># set continuous (call the actionbutton's function)</span></span>
        self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>btn_toggle_continuous<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">incr_action</span></span><span style="color: #990000">()</span>
    <span style="font-weight: bold"><span style="color: #0000FF">else</span></span><span style="color: #990000">:</span>
        <span style="font-style: italic"><span style="color: #9A1900"># reset previously recorded increment</span></span>
        ACTION<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">SET_JOG_INCR</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>L_incr<span style="color: #990000">,</span> self<span style="color: #990000">.</span>L_text<span style="color: #990000">)</span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_class_patch_the_file_manager_widget">10. Class Patch The File Manager Widget</h2>
<div class="sectionbody">
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Class patching (monkey patching) is a little like <em>black magic</em> - so use it <em>only if needed</em>.</td>
</tr></table>
</div>
<div class="paragraph"><p>The File manager widget is designed to load a selected program in LinuxCNC.
But maybe you want to print the file name first.</p></div>
<div class="paragraph"><p>We can "class patch" the library to <em>redirect the function call</em>.
In the <code>IMPORT SECTION</code> add:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> qtvcp<span style="color: #990000">.</span>widgets<span style="color: #990000">.</span>file_manager <span style="font-weight: bold"><span style="color: #000080">import</span></span> FileManager as FM</tt></pre></div></div>
<div class="paragraph"><p>Here we are going to:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<em>Keep a reference to the original function</em> (1) so we can still call it
</p>
</li>
<li>
<p>
<em>Redirect the class to call our custom function</em> (2) in the handler file instead.
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">##########################################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># Special Functions called from QtVCP    #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">##########################################</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># For changing functions in widgets we can 'class patch'.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># class patching must be done before the class is instantiated.</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">class_patch__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
    self<span style="color: #990000">.</span>old_load <span style="color: #990000">=</span> FM<span style="color: #990000">.</span>load <span style="font-style: italic"><span style="color: #9A1900"># keep a reference of the old function <b>&lt;1&gt;</b></span></span>
    FM<span style="color: #990000">.</span>load <span style="color: #990000">=</span> self<span style="color: #990000">.</span>our_load <span style="font-style: italic"><span style="color: #9A1900"># redirect function to our handle file function <b>&lt;2&gt;</b></span></span></tt></pre></div></div>
</li>
<li>
<p>
<em>Write a custom function to replace the original</em>:<br />
  This function must have the <strong>same signature as the original function</strong>.<br />
  In this example we are still going to call the original function by using the reference to it we recorded earlier.<br />
  It <em>requires the first argument to be the widget instance</em>,
  which in this case is <code>self.w.filemanager</code> (the name given in the Qt Designer editor).
</p>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># GENERAL FUNCTIONS #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">our_load</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>fname<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">print</span></span><span style="color: #990000">(</span>fname<span style="color: #990000">)</span>
    self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">old_load</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>filemanager<span style="color: #990000">,</span>fname<span style="color: #990000">)</span></tt></pre></div></div>
</li>
</ol></div>
<div class="paragraph"><p>Now our custom function will print the file path to the terminal before loading the file.
Obviously boring but shows the principle.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>There is another slightly different way to do this that can have advantages:
you can <em>store the reference to the original function in the original class</em>.<br />
The trick here is to make sure the function name you use to store it is not already used in the class.<br />
<code>super__</code> added to the function name would be a good choice.<br />
We won&#8217;t use that in built in QtVCP widgets.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">##########################################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># Special Functions called from QtVCP</span></span>
<span style="font-style: italic"><span style="color: #9A1900">##########################################</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># For changing functions in widgets we can 'class patch'.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># class patching must be done before the class is instantiated.</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">class_patch__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
    FM<span style="color: #990000">.</span>super__load <span style="color: #990000">=</span> FM<span style="color: #990000">.</span>load <span style="font-style: italic"><span style="color: #9A1900"># keep a reference of the old function in the original class</span></span>
    FM<span style="color: #990000">.</span>load <span style="color: #990000">=</span> self<span style="color: #990000">.</span>our_load <span style="font-style: italic"><span style="color: #9A1900"># redirect function to our handle file function</span></span>

<span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># GENERAL FUNCTIONS #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">our_load</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>fname<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">print</span></span><span style="color: #990000">(</span>fname<span style="color: #990000">)</span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>filemanager<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">super__load</span></span><span style="color: #990000">(</span>fname<span style="color: #990000">)</span></tt></pre></div></div>
</td>
</tr></table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_widgets_programmatically">11. Adding Widgets Programmatically</h2>
<div class="sectionbody">
<div class="paragraph"><p>In some situation it is only possible to <strong>add widgets with Python code</strong> rather then using the Qt Designer editor.</p></div>
<div class="paragraph"><p>When adding QtVCP widgets programmatically, sometimes there are <em>extra steps</em> to be taken.</p></div>
<div class="paragraph"><p>Here we are going to add a spindle speed indicator bar and up-to-speed LED to a tab widget corner.
Qt Designer does not support adding corner widgets to tabs but PyQt does.</p></div>
<div class="paragraph"><p>This is a cut down example from QtAxis screen&#8217;s handler file.</p></div>
<div class="paragraph"><div class="title">Import required libraries</div><p>First we must import the libraries we need, if they&#8217;re not already imported in the handler file:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>QtWidgets</code> gives us access to the <code>QProgressBar</code>,
</p>
</li>
<li>
<p>
<code>QColor</code> is for the <em>LED color</em>,
</p>
</li>
<li>
<p>
<code>StateLED</code> is the QtVCP library used to <em>create the spindle-at-speed LED</em>,
</p>
</li>
<li>
<p>
<code>Status</code> is used to <em>catch LinuxCNC status information</em>,
</p>
</li>
<li>
<p>
<code>Info</code> gives us <em>information about the machine configuration</em>.
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">############################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># **** IMPORT SECTION **** #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">############################</span></span>

<span style="font-weight: bold"><span style="color: #000080">from</span></span> PyQt5 <span style="font-weight: bold"><span style="color: #000080">import</span></span> QtWidgets
<span style="font-weight: bold"><span style="color: #000080">from</span></span> PyQt5<span style="color: #990000">.</span>QtGui <span style="font-weight: bold"><span style="color: #000080">import</span></span> QColor
<span style="font-weight: bold"><span style="color: #000080">from</span></span> qtvcp<span style="color: #990000">.</span>widgets<span style="color: #990000">.</span>state_led <span style="font-weight: bold"><span style="color: #000080">import</span></span> StateLED as LED
<span style="font-weight: bold"><span style="color: #000080">from</span></span> qtvcp<span style="color: #990000">.</span>core <span style="font-weight: bold"><span style="color: #000080">import</span></span> Status<span style="color: #990000">,</span> Info</tt></pre></div></div>
<div class="paragraph"><div class="title">Instantiate <code>Status</code> and <code>Info</code> channels</div><p><code>STATUS</code> and <code>INFO</code> are initialized outside the handler class so as to be <em>global references</em> (no self. in front):</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">##########################################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># **** instantiate libraries section **** #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">###########################################</span></span>

STATUS <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Status</span></span><span style="color: #990000">()</span>
INFO <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Info</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><div class="title">Register <code>STATUS</code> monitoring function</div><p>For the spindle speed indicator we need to know the current spindle speed.
For this we <em>register</em> with <code>STATUS</code> to:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>Catch</em> the <code>actual-spindle-speed-changed</code> <em>signal</em>
</p>
</li>
<li>
<p>
<em>Call</em> the <code>self.update_spindle()</code> <em>function</em>
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">########################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># **** INITIALIZE **** #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">########################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># Widgets allow access to widgets from the QtVCP files.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># At this point the widgets and HAL pins are not instantiated.</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">__init__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>halcomp<span style="color: #990000">,</span>widgets<span style="color: #990000">,</span>paths<span style="color: #990000">):</span>
    self<span style="color: #990000">.</span>hal <span style="color: #990000">=</span> halcomp
    self<span style="color: #990000">.</span>w <span style="color: #990000">=</span> widgets
    self<span style="color: #990000">.</span>PATHS <span style="color: #990000">=</span> paths

    STATUS<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">connect</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'actual-spindle-speed-changed'</span><span style="color: #990000">,</span> <span style="color: #990000">\</span>
        <span style="font-weight: bold"><span style="color: #0000FF">lambda</span></span> w<span style="color: #990000">,</span>speed<span style="color: #990000">:</span> self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">update_spindle</span></span><span style="color: #990000">(</span>speed<span style="color: #990000">))</span></tt></pre></div></div>
<div class="paragraph"><div class="title">Add the widgets to the tab</div><p>We need to <em>make sure the Qt Designer widgets are already built</em> before we try to add to them.
For this, we add a call to <code>self.make_corner_widgets()</code> function to build our extra widgets at the right time, i.e. under the <code>initialized__()</code> function:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">##########################################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># Special Functions called from QtScreen #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">##########################################</span></span>

<span style="font-style: italic"><span style="color: #9A1900"># at this point:</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># the widgets are instantiated.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># the HAL pins are built but HAL is not set ready</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">initialized__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
    self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">make_corner_widgets</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><div class="title">Create the widgets building functions</div><p>Ok let&#8217;s code the function to build the widgets and add them in the tab widget.
We are assuming there is a tab widget built with Designer called <em>rightTab</em>.</p></div>
<div class="paragraph"><p>We are assuming there is a tab widget built with Qt Designer called <code>rightTab</code>.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># general functions #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">make_corner_widgets</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
    <span style="font-style: italic"><span style="color: #9A1900"># make a spindle-at-speed green LED</span></span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>led <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">LED</span></span><span style="color: #990000">()</span>                                        <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;1&gt;</b></span></span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>led<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setProperty</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'is_spindle_at_speed_status'</span><span style="color: #990000">,</span>True<span style="color: #990000">)</span> <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;2&gt;</b></span></span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>led<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setProperty</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'color'</span><span style="color: #990000">,</span><span style="font-weight: bold"><span style="color: #000000">QColor</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">,</span><span style="color: #993399">255</span><span style="color: #990000">,</span><span style="color: #993399">0</span><span style="color: #990000">,</span><span style="color: #993399">255</span><span style="color: #990000">))</span>       <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;3&gt;</b></span></span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>led<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">hal_init</span></span><span style="color: #990000">(</span>HAL_NAME <span style="color: #990000">=</span> <span style="color: #FF0000">'spindle_is_at_speed'</span><span style="color: #990000">)</span>     <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;4&gt;</b></span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># make a spindle speed bar</span></span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>rpm_bar <span style="color: #990000">=</span> QtWidgets<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">QProgressBar</span></span><span style="color: #990000">()</span>                 <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;5&gt;</b></span></span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>rpm_bar<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setRange</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">,</span> INFO<span style="color: #990000">.</span>MAX_SPINDLE_SPEED<span style="color: #990000">)</span>        <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;6&gt;</b></span></span>

    <span style="font-style: italic"><span style="color: #9A1900"># container</span></span>
    w <span style="color: #990000">=</span> QtWidgets<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">QWidget</span></span><span style="color: #990000">()</span>                                   <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;7&gt;</b></span></span>
    w<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setContentsMargins</span></span><span style="color: #990000">(</span><span style="color: #993399">0</span><span style="color: #990000">,</span><span style="color: #993399">0</span><span style="color: #990000">,</span><span style="color: #993399">0</span><span style="color: #990000">,</span><span style="color: #993399">6</span><span style="color: #990000">)</span>
    w<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setMinimumHeight</span></span><span style="color: #990000">(</span><span style="color: #993399">40</span><span style="color: #990000">)</span>

    <span style="font-style: italic"><span style="color: #9A1900"># layout</span></span>
    hbox <span style="color: #990000">=</span> QtWidgets<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">QHBoxLayout</span></span><span style="color: #990000">()</span>                            <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;8&gt;</b></span></span>
    hbox<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addWidget</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>rpm_bar<span style="color: #990000">)</span>                            <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;9&gt;</b></span></span>
    hbox<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">addWidget</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>led<span style="color: #990000">)</span>                                <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;9&gt;</b></span></span>
    w<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setLayout</span></span><span style="color: #990000">(</span>hbox<span style="color: #990000">)</span>

    <span style="font-style: italic"><span style="color: #9A1900"># add the container to the corner of the right tab widget</span></span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>rightTab<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setCornerWidget</span></span><span style="color: #990000">(</span>w<span style="color: #990000">)</span>                        <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;10&gt;</b></span></span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
This initializes the basic StateLed widget and uses <code>self.w.led</code> as the reference from then on.
</p>
</li>
<li>
<p>
Since the state LED can be used for many indications, we must set the property that designates it as a spindle-at-speed LED.
</p>
</li>
<li>
<p>
This sets it as green when on.
</p>
</li>
<li>
<p>
This is the extra function call required with some QtVCP widgets.<br />
    If <code>HAL_NAME</code> is omitted it will use the widget&#8217;s <code>objectName</code> if there is one.<br />
    It gives the special widgets reference to:
</p>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong><code>self.HAL_GCOMP</code></strong>
</dt>
<dd>
<p>
the <em>HAL component</em> instance
</p>
</dd>
<dt class="hdlist1">
<strong><code>self.HAL_NAME</code></strong>
</dt>
<dd>
<p>
This <em>widget&#8217;s name</em> as a string
</p>
</dd>
<dt class="hdlist1">
<strong><code>self.QT_OBJECT_</code></strong>
</dt>
<dd>
<p>
This <em>widget&#8217;s PyQt object instance</em>
</p>
</dd>
<dt class="hdlist1">
<strong><code>self.QTVCP_INSTANCE_</code></strong>
</dt>
<dd>
<p>
The <em>very top level parent</em> of the screen
</p>
</dd>
<dt class="hdlist1">
<strong><code>self.PATHS_</code></strong>
</dt>
<dd>
<p>
The <em>instance of QtVCP&#8217;s path</em> library
</p>
</dd>
<dt class="hdlist1">
<strong><code>self.PREFS_</code></strong>
</dt>
<dd>
<p>
the <em>instance of an optional preference file</em>
</p>
</dd>
<dt class="hdlist1">
<strong><code>self.SETTINGS_</code></strong>
</dt>
<dd>
<p>
the <code>Qsettings</code> <em>object</em>
</p>
</dd>
</dl></div>
</li>
<li>
<p>
Initializes a PyQt5 <code>QProgressBar</code>.
</p>
</li>
<li>
<p>
Sets the max range of the progress bar to the max specified in the <code>INI</code>.
</p>
</li>
<li>
<p>
We create a QWidget<br />
    Since you can only add one widget to the tab corner and we want two there, we must add both into a <strong>container</strong>.
</p>
</li>
<li>
<p>
add a QHBoxLayout to the QWidget.<br />
</p>
</li>
<li>
<p>
Then we add our QProgress bar and LED to the layout.
</p>
</li>
<li>
<p>
Finally we add the QWidget (with our QProgress bar and LED in it) to the tab widget&#8217;s corner.
</p>
</li>
</ol></div>
<div class="paragraph"><div class="title">Create the <code>STATUS</code> monitoring function</div><p>Now we build the function to actually update out the <code>QProgressBar</code> when <code>STATUS</code> updates the spindle speed:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">########################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># callbacks from STATUS #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">########################</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">update_spindle</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> data<span style="color: #990000">):</span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>rpm_bar<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setInvertedAppearance</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">bool</span></span><span style="color: #990000">(</span>data<span style="color: #990000">&lt;</span><span style="color: #993399">0</span><span style="color: #990000">))</span>       <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;1&gt;</b></span></span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>rpm_bar<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setFormat</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'{0:d} RPM'</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">int</span></span><span style="color: #990000">(</span>data<span style="color: #990000">)))</span>  <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;2&gt;</b></span></span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>rpm_bar<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setValue</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">abs</span></span><span style="color: #990000">(</span>data<span style="color: #990000">))</span>                       <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;3&gt;</b></span></span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
In this case we chose to display left-to-right or right-to-left,
    depending if we are turning clockwise or anticlockwise.
</p>
</li>
<li>
<p>
This formats the writing in the bar.
</p>
</li>
<li>
<p>
This sets the length of the colored bar.
</p>
</li>
</ol></div>
</div>
</div>
<div class="sect1">
<h2 id="_update_read_objects_periodically">12. Update/Read Objects Periodically</h2>
<div class="sectionbody">
<div class="paragraph"><p>Sometimes you need to <strong>update a widget or read a value regularly</strong> that isn&#8217;t covered by normal libraries.</p></div>
<div class="paragraph"><p>Here we update an LED based on a watched HAL pin every 100&#8239;ms.</p></div>
<div class="paragraph"><p>We assume there is an LED named <code>led</code> in the Qt Designer UI file.</p></div>
<div class="paragraph"><div class="title">Load the <code>Qhal</code> library for access to QtVCP&#8217;s HAL component</div><p>In the <code>IMPORT SECTION</code> add:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">from</span></span> qtvcp<span style="color: #990000">.</span>core <span style="font-weight: bold"><span style="color: #000080">import</span></span> Qhal</tt></pre></div></div>
<div class="paragraph"><div class="title">Instantiate <code>Qhal</code></div><p>In the <code>INSTANTIATE LIBRARY SECTION</code> add:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>QHAL <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">Qhal</span></span><span style="color: #990000">()</span></tt></pre></div></div>
<div class="paragraph"><p>Now add/modify these sections to include code that is similar to this:</p></div>
<div class="paragraph"><div class="title">Register a function to be called at <code>CYCLE_TIME</code> period</div><p>This is usually every 100&#8239;ms.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">########################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># **** INITIALIZE **** #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">########################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># widgets allows access to widgets from the QtVCP files</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># at this point the widgets and hal pins are not instantiated</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">__init__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>halcomp<span style="color: #990000">,</span>widgets<span style="color: #990000">,</span>paths<span style="color: #990000">):</span>
    self<span style="color: #990000">.</span>hal <span style="color: #990000">=</span> halcomp
    self<span style="color: #990000">.</span>w <span style="color: #990000">=</span> widgets
    self<span style="color: #990000">.</span>PATHS <span style="color: #990000">=</span> paths

    <span style="font-style: italic"><span style="color: #9A1900"># register a function to be called at CYCLE_TIME period (usually every 100 ms)</span></span>
    STATUS<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">connect</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'periodic'</span><span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #0000FF">lambda</span></span> w<span style="color: #990000">:</span> self<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">update_periodic</span></span><span style="color: #990000">())</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">Create the custom function to be called periodically</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># general functions #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">update_periodic</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
    data <span style="color: #990000">=</span> QHAL<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">getvalue</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'spindle.0.is-oriented'</span><span style="color: #990000">)</span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>led<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setState</span></span><span style="color: #990000">(</span>data<span style="color: #990000">)</span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_external_control_with_zmq">13. External Control With ZMQ</h2>
<div class="sectionbody">
<div class="paragraph"><p><em>QtVCP can automatically set up</em> <strong>ZMQ messaging</strong> <em>to send and/or receive remote messages from external programs</em>.</p></div>
<div class="paragraph"><p>It uses ZMQ&#8217;s <strong>publish/subscribe messaging pattern</strong>.</p></div>
<div class="paragraph"><p>As always, consider <strong>security</strong> before letting programs interface though messaging.</p></div>
<div class="sect2">
<h3 id="_zmq_messages_reading">13.1. ZMQ Messages Reading</h3>
<div class="paragraph"><p>Sometimes you want to <strong>control the screen with a separate program</strong>.</p></div>
<div class="paragraph"><div class="title">Enable reception of ZMQ messages</div><p>In the <code>ScreenOptions</code> widget, you can select the property <strong><code>use_receive_zmq_option</code></strong>.<br />
You can also set this property directly <em>in the handler file</em>, as in this sample.</p></div>
<div class="paragraph"><p>We assume the <code>ScreenOptions</code> widget is called <code>screen_options</code> in Qt Designer:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">########################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># **** INITIALIZE **** #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">########################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># widgets allows access to widgets from the QtVCP files</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># at this point the widgets and hal pins are not instantiated</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">__init__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span>halcomp<span style="color: #990000">,</span>widgets<span style="color: #990000">,</span>paths<span style="color: #990000">):</span>
    <span style="font-style: italic"><span style="color: #9A1900"># directly select ZMQ message receiving</span></span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>screen_options<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setProperty</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'use_receive_zmq_option'</span><span style="color: #990000">,</span>True<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This <strong>allows an external program to call functions in the handler file</strong>.</p></div>
<div class="paragraph"><div class="title">Add a function to be called on ZMQ message reception</div><p>Let&#8217;s add a specific function for testing.
You will need to run LinuxCNC from a terminal to see the printed text.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># general functions #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">test_zmq_function</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> arg1<span style="color: #990000">,</span> arg2<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">print</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'zmq_test_function called: '</span><span style="color: #990000">,</span> arg1<span style="color: #990000">,</span> arg2<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><div class="title">Create an external program sending ZMQ messages that will trigger function call</div><p>Here is a sample external program to call a function.
It alternates between two data sets every second.
Run this in a separate terminal from LinuxCNC to see the sent messages.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">#!/usr/bin/env python3</span></span>
<span style="font-weight: bold"><span style="color: #000080">from</span></span> time <span style="font-weight: bold"><span style="color: #000080">import</span></span> sleep

<span style="font-weight: bold"><span style="color: #000080">import</span></span> zmq
<span style="font-weight: bold"><span style="color: #000080">import</span></span> json

context <span style="color: #990000">=</span> zmq<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Context</span></span><span style="color: #990000">()</span>
socket <span style="color: #990000">=</span> context<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">socket</span></span><span style="color: #990000">(</span>zmq<span style="color: #990000">.</span>PUB<span style="color: #990000">)</span>
socket<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">bind</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"tcp://127.0.0.1:5690"</span><span style="color: #990000">)</span>
topic <span style="color: #990000">=</span> b<span style="color: #FF0000">'QtVCP'</span>

<span style="font-style: italic"><span style="color: #9A1900"># prebuilt message 1</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># makes a dict of function to call plus any arguments</span></span>
x <span style="color: #990000">=</span> <span style="color: #990000">{</span>                               <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;1&gt;</b></span></span>
  <span style="color: #FF0000">"FUNCTION"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"test_zmq_function"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"ARGS"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>True<span style="color: #990000">,</span><span style="color: #993399">200</span><span style="color: #990000">]</span>
<span style="color: #990000">}</span>
<span style="font-style: italic"><span style="color: #9A1900"># convert to JSON object</span></span>
m1 <span style="color: #990000">=</span> json<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">dumps</span></span><span style="color: #990000">(</span>x<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900"># prebuild message 2</span></span>
x <span style="color: #990000">=</span> <span style="color: #990000">{</span>                               <span style="font-style: italic"><span style="color: #9A1900"># <b>&lt;1&gt;</b></span></span>
  <span style="color: #FF0000">"FUNCTION"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"test_zmq_function"</span><span style="color: #990000">,</span>
  <span style="color: #FF0000">"ARGS"</span><span style="color: #990000">:</span> <span style="color: #990000">[</span>False<span style="color: #990000">,</span><span style="color: #993399">0</span><span style="color: #990000">],</span>
<span style="color: #990000">}</span>
<span style="font-style: italic"><span style="color: #9A1900"># convert to JSON object</span></span>
m2 <span style="color: #990000">=</span> json<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">dumps</span></span><span style="color: #990000">(</span>x<span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> __name__ <span style="color: #990000">==</span> <span style="color: #FF0000">'__main__'</span><span style="color: #990000">:</span>
    <span style="font-weight: bold"><span style="color: #0000FF">while</span></span> True<span style="color: #990000">:</span>
        <span style="font-weight: bold"><span style="color: #0000FF">print</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'send message 1'</span><span style="color: #990000">)</span>
        socket<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_multipart</span></span><span style="color: #990000">([</span>topic<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">bytes</span></span><span style="color: #990000">((</span>m1<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">encode</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'utf-8'</span><span style="color: #990000">))])</span>
        <span style="font-weight: bold"><span style="color: #000000">sleep</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">ms</span></span><span style="color: #990000">(</span><span style="color: #993399">1000</span><span style="color: #990000">))</span>

        <span style="font-weight: bold"><span style="color: #0000FF">print</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'send message 2'</span><span style="color: #990000">)</span>
        socket<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_multipart</span></span><span style="color: #990000">([</span>topic<span style="color: #990000">,</span> <span style="font-weight: bold"><span style="color: #000000">bytes</span></span><span style="color: #990000">((</span>m2<span style="color: #990000">).</span><span style="font-weight: bold"><span style="color: #000000">encode</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'utf-8'</span><span style="color: #990000">))])</span>
        <span style="font-weight: bold"><span style="color: #000000">sleep</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">ms</span></span><span style="color: #990000">(</span><span style="color: #993399">1000</span><span style="color: #990000">))</span></tt></pre></div></div>
<div class="colist arabic"><ol>
<li>
<p>
Set the <strong>function to call</strong> and the <strong>arguments to send</strong> to that function.
</p>
</li>
</ol></div>
<div class="paragraph"><p>You will need to know the <em>signature</em> of the function you wish to call.
Also note that the <em>message is converted to a JSON object</em>.
This is because ZMQ sends byte messages not Python objects.
<code>json</code> converts Python objects to bytes and will be converted back when received.</p></div>
</div>
<div class="sect2">
<h3 id="_zmq_messages_writing">13.2. ZMQ Messages Writing</h3>
<div class="paragraph"><p>You may also want to <strong>communicate with an external program from the screen</strong>.</p></div>
<div class="paragraph"><p>In the <code>ScreenOptions</code> widget, you can select the property <strong><code>use_send_zmq_message</code></strong>.
You can also set this property directly <em>in the handler file</em>, as in this sample.</p></div>
<div class="paragraph"><p>We assume the <code>ScreenOptions</code> widget is called <code>screen_options</code> in Qt Designer:</p></div>
<div class="listingblock">
<div class="title">Enable sending of ZMQ messages</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">########################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># **** INITIALIZE **** #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">########################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># widgets allows access to  widgets from the QtVCP files</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># at this point the widgets and hal pins are not instantiated</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">__init__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> halcomp<span style="color: #990000">,</span>widgets<span style="color: #990000">,</span>paths<span style="color: #990000">):</span>
    <span style="font-style: italic"><span style="color: #9A1900"># directly select ZMQ message sending</span></span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>screen_options<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setProperty</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'use_send_zmq_option'</span><span style="color: #990000">,</span>True<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>This allows sending messages to a separate program.<br />
The message sent will depend on what the external program is expecting.</p></div>
<div class="paragraph"><div class="title">Create a function to send ZMQ messages</div><p>Let&#8217;s add a specific function for testing.<br />
You will need to run LinuxCNC from a terminal to see the printed text.<br />
Also, something needs to be added to call this function, such as a button click.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># general functions #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">send_zmq_message</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
    <span style="font-style: italic"><span style="color: #9A1900"># This could be any Python object JSON can convert</span></span>
    message <span style="color: #990000">=</span> <span style="color: #990000">{</span><span style="color: #FF0000">"name"</span><span style="color: #990000">:</span> <span style="color: #FF0000">"John"</span><span style="color: #990000">,</span> <span style="color: #FF0000">"age"</span><span style="color: #990000">:</span> <span style="color: #993399">30</span><span style="color: #990000">}</span>
    self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>screen_options<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">send_zmq_message</span></span><span style="color: #990000">(</span>message<span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><div class="title">Use or create a program that will receive ZMQ messages</div><p>Here is a sample program that will receive the message and print it to the terminal:</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-weight: bold"><span style="color: #000080">import</span></span> zmq
<span style="font-weight: bold"><span style="color: #000080">import</span></span> json

<span style="font-style: italic"><span style="color: #9A1900"># ZeroMQ Context</span></span>
context <span style="color: #990000">=</span> zmq<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">Context</span></span><span style="color: #990000">()</span>

<span style="font-style: italic"><span style="color: #9A1900"># Define the socket using the "Context"</span></span>
sock <span style="color: #990000">=</span> context<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">socket</span></span><span style="color: #990000">(</span>zmq<span style="color: #990000">.</span>SUB<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900"># Define subscription and messages with topic to accept.</span></span>
topic <span style="color: #990000">=</span> <span style="color: #FF0000">""</span> <span style="font-style: italic"><span style="color: #9A1900"># all topics</span></span>
sock<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">setsockopt</span></span><span style="color: #990000">(</span>zmq<span style="color: #990000">.</span>SUBSCRIBE<span style="color: #990000">,</span> topic<span style="color: #990000">)</span>
sock<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">connect</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"tcp://127.0.0.1:5690"</span><span style="color: #990000">)</span>

<span style="font-weight: bold"><span style="color: #0000FF">while</span></span> True<span style="color: #990000">:</span>
    topic<span style="color: #990000">,</span> message <span style="color: #990000">=</span> sock<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">recv_multipart</span></span><span style="color: #990000">()</span>
    <span style="font-weight: bold"><span style="color: #0000FF">print</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'{} sent message:{}'</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span>topic<span style="color: #990000">,</span>json<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">loads</span></span><span style="color: #990000">(</span>message<span style="color: #990000">)))</span>
</tt></pre></div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sending_messages_to_status_bar_or_desktop_notify_dialogs">14. Sending Messages To Status Bar Or Desktop Notify Dialogs</h2>
<div class="sectionbody">
<div class="paragraph"><p>There are several ways to <strong>report information to the user</strong>.</p></div>
<div class="paragraph"><p>A <strong>status bar</strong> is used for <em>short information</em> to show the user.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">Not all screens have a status bar.</td>
</tr></table>
</div>
<div class="listingblock">
<div class="title">Status bar usage example</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>statusbar<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">showMessage</span></span><span style="color: #990000">(</span>message<span style="color: #990000">,</span> timeout <span style="color: #990000">*</span> <span style="color: #993399">1000</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p><code>timeout</code> is in seconds and we assume <code>statusbar</code> is the Qt Designer set name of the widget.</p></div>
<div class="paragraph"><p>You can also use the <code>Status</code> library to send a message to the <code>notify</code> library if it is enabled (usually set in <code>ScreenOptions</code> widget):
This will send the message to the statusbar and the <strong>desktop notify dialog</strong>.</p></div>
<div class="paragraph"><p>The messages are also recorded until the user erases them using controls.
The users can recall any recorded messages.</p></div>
<div class="paragraph"><p>There are several options:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<strong><code>STATUS.TEMPORARY_MESSAGE</code></strong>
</dt>
<dd>
<p>
Show the message for a short time only.
</p>
</dd>
<dt class="hdlist1">
<strong><code>STATUS.OPERATOR_ERROR</code></strong>
</dt>
<dt class="hdlist1">
<strong><code>STATUS.OPERATOR_TEXT</code></strong>
</dt>
<dt class="hdlist1">
<strong><code>STATUS.NML_ERROR</code></strong>
</dt>
<dt class="hdlist1">
<strong><code>STATUS.NML_TEXT</code></strong>
</dt>
<dd>
<p>
</p>
</dd>
</dl></div>
<div class="listingblock">
<div class="title">Example of sending an operator message:</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>STATUS<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">emit</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'error'</span><span style="color: #990000">,</span> STATUS<span style="color: #990000">.</span>OPERATOR_ERROR<span style="color: #990000">,</span> <span style="color: #FF0000">'message'</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>You can send messages thru LinuxCNC&#8217;s operator message functions.
These are usually caught by the notify system, so are equal to above.
They would be printed to the terminal as well.</p></div>
<div class="listingblock">
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>ACTION<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">SET_DISPLAY_MESSAGE</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'MESSAGE'</span><span style="color: #990000">)</span>
ACTION<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">SET_ERROR_MESSAGE</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'MESSAGE'</span><span style="color: #990000">)</span></tt></pre></div></div>
</div>
</div>
<div class="sect1">
<h2 id="_catch_focus_changes">15. Catch Focus Changes</h2>
<div class="sectionbody">
<div class="paragraph"><p>Focus is used to <strong>direct user action</strong> such as keyboard entry to the proper widget.</p></div>
<div class="listingblock">
<div class="title">Get currently focused widget</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>fwidget <span style="color: #990000">=</span> QtWidgets<span style="color: #990000">.</span>QApplication<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">focusWidget</span></span><span style="color: #990000">()</span>
<span style="font-weight: bold"><span style="color: #0000FF">if</span></span> fwidget <span style="font-weight: bold"><span style="color: #0000FF">is</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> None<span style="color: #990000">:</span>
    <span style="font-weight: bold"><span style="color: #0000FF">print</span></span><span style="color: #990000">(</span><span style="color: #FF0000">"focus widget class: {} name: {} "</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span>fwidget<span style="color: #990000">,</span> fwidget<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">objectName</span></span><span style="color: #990000">()))</span></tt></pre></div></div>
<div class="listingblock">
<div class="title">Get focused widget when focus changes</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><span style="font-style: italic"><span style="color: #9A1900"># at this point:</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># the widgets are instantiated.</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># the HAL pins are built but HAL is not set ready</span></span>
<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">initialized__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>
    QtWidgets<span style="color: #990000">.</span>QApplication<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">instance</span></span><span style="color: #990000">().</span>event_filter<span style="color: #990000">.</span>focusIn<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">connect</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>focusInChanged<span style="color: #990000">)</span>

<span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>
<span style="font-style: italic"><span style="color: #9A1900"># general functions #</span></span>
<span style="font-style: italic"><span style="color: #9A1900">#####################</span></span>

<span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">focusInChanged</span></span><span style="color: #990000">(</span>self<span style="color: #990000">,</span> widget<span style="color: #990000">):</span>
    <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="font-weight: bold"><span style="color: #000000">isinstance</span></span><span style="color: #990000">(</span>widget<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parent</span></span><span style="color: #990000">(),</span><span style="font-weight: bold"><span style="color: #000000">type</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>gcode_editor<span style="color: #990000">.</span>editor<span style="color: #990000">)):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">print</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'G-code Editor'</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">elif</span></span> <span style="font-weight: bold"><span style="color: #000000">isinstance</span></span><span style="color: #990000">(</span>widget<span style="color: #990000">,</span><span style="font-weight: bold"><span style="color: #000000">type</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>gcodegraphics<span style="color: #990000">)):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">print</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'G-code Display'</span><span style="color: #990000">)</span>
    <span style="font-weight: bold"><span style="color: #0000FF">elif</span></span> <span style="font-weight: bold"><span style="color: #000000">isinstance</span></span><span style="color: #990000">(</span>widget<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">parent</span></span><span style="color: #990000">(),</span><span style="font-weight: bold"><span style="color: #000000">type</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>mdihistory<span style="color: #990000">)</span> <span style="color: #990000">):</span>
        <span style="font-weight: bold"><span style="color: #0000FF">print</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'MDI History'</span><span style="color: #990000">)</span></tt></pre></div></div>
<div class="paragraph"><p>Notice we sometimes compare to <code>widget</code>, sometimes to <code>widget.parent()</code>.</p></div>
<div class="paragraph"><p>This is because <em>some QtVCP widgets are built from multiple</em> <strong><em>sub-widgets</em></strong> and the latter actually get the focus; so we need to <strong>check the parent</strong> of those sub-widgets.</p></div>
<div class="paragraph"><p>Other times the main widget is what gets the focus, e.g., the G-code display widget can be set to accept the focus.
In that case there are no sub-widgets in it, so comparing to the <code>widget.parent()</code> would get you the container that holds the G-code widget.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_read_command_line_load_time_options">16. Read Command Line Load Time Options</h2>
<div class="sectionbody">
<div class="paragraph"><p>Some panels need information at load time for setup/options. Qtvcp covers this requirement with <em>-o</em> options.<br />
The <em>-o</em> argument is good for a few, relatively short options, that can be added to the loading command line.<br />
For more involved information, reading an INI or preference file is probably a better idea.<br /></p></div>
<div class="paragraph"><p>Multiple <em>-o</em> options can be used on the command line so you must decode them.<br />
<em>self.w.USEROPTIONS_</em> will hold any found <em>-o</em> options as a list of strings.
You must parse and define what is accepted and what to do with it.</p></div>
<div class="listingblock">
<div class="title">Example code to get -o options for camera number and window size</div>
<div class="content"><!-- Generator: GNU source-highlight 3.1.9
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>    <span style="font-weight: bold"><span style="color: #0000FF">def</span></span> <span style="font-weight: bold"><span style="color: #000000">initialized__</span></span><span style="color: #990000">(</span>self<span style="color: #990000">):</span>

        <span style="font-style: italic"><span style="color: #9A1900"># set a default camera number</span></span>
        number <span style="color: #990000">=</span> <span style="color: #993399">0</span>

        <span style="font-style: italic"><span style="color: #9A1900"># check if there are any -o options at all</span></span>
        <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>USEROPTIONS_ <span style="font-weight: bold"><span style="color: #0000FF">is</span></span> <span style="font-weight: bold"><span style="color: #0000FF">not</span></span> None<span style="color: #990000">:</span>

            <span style="font-style: italic"><span style="color: #9A1900"># if in debug mode print the options to the terminal</span></span>
            LOG<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">debug</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'cam_align user options: {}'</span><span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">format</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>USEROPTIONS_<span style="color: #990000">))</span>

            <span style="font-style: italic"><span style="color: #9A1900"># go through the found options one by one</span></span>
            <span style="font-weight: bold"><span style="color: #0000FF">for</span></span> num<span style="color: #990000">,</span> i <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> <span style="font-weight: bold"><span style="color: #000000">enumerate</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>USEROPTIONS_<span style="color: #990000">):</span>

                <span style="font-style: italic"><span style="color: #9A1900"># if the -o option has 'size=' in it, assume it's width and height of window</span></span>
                <span style="font-style: italic"><span style="color: #9A1900"># override the default width and height of the window</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">if</span></span> <span style="color: #FF0000">'size='</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>USEROPTIONS_<span style="color: #990000">[</span>num<span style="color: #990000">]:</span>
                    <span style="font-weight: bold"><span style="color: #0000FF">try</span></span><span style="color: #990000">:</span>
                        strg <span style="color: #990000">=</span> self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>USEROPTIONS_<span style="color: #990000">[</span>num<span style="color: #990000">].</span><span style="font-weight: bold"><span style="color: #000000">strip</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'size='</span><span style="color: #990000">)</span>
                        arg <span style="color: #990000">=</span> strg<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">split</span></span><span style="color: #990000">(</span><span style="color: #FF0000">','</span><span style="color: #990000">)</span>
                        self<span style="color: #990000">.</span>w<span style="color: #990000">.</span><span style="font-weight: bold"><span style="color: #000000">resize</span></span><span style="color: #990000">(</span><span style="font-weight: bold"><span style="color: #000000">int</span></span><span style="color: #990000">(</span>arg<span style="color: #990000">[</span><span style="color: #993399">0</span><span style="color: #990000">]),</span><span style="font-weight: bold"><span style="color: #000000">int</span></span><span style="color: #990000">(</span>arg<span style="color: #990000">[</span><span style="color: #993399">1</span><span style="color: #990000">]))</span>
                    <span style="font-weight: bold"><span style="color: #0000FF">except</span></span> Exception as e<span style="color: #990000">:</span>
                        <span style="font-weight: bold"><span style="color: #0000FF">print</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Error with cam_align size setting:'</span><span style="color: #990000">,</span>self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>USEROPTIONS_<span style="color: #990000">[</span>num<span style="color: #990000">])</span>

                <span style="font-style: italic"><span style="color: #9A1900">#  # if the -o option has 'camnumber=' in it, assume it's the camera number to use</span></span>
                <span style="font-weight: bold"><span style="color: #0000FF">elif</span></span> <span style="color: #FF0000">'camnumber='</span> <span style="font-weight: bold"><span style="color: #0000FF">in</span></span> self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>USEROPTIONS_<span style="color: #990000">[</span>num<span style="color: #990000">]:</span>
                    <span style="font-weight: bold"><span style="color: #0000FF">try</span></span><span style="color: #990000">:</span>
                        number <span style="color: #990000">=</span> <span style="font-weight: bold"><span style="color: #000000">int</span></span><span style="color: #990000">(</span>self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>USEROPTIONS_<span style="color: #990000">[</span>num<span style="color: #990000">].</span><span style="font-weight: bold"><span style="color: #000000">strip</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'camnumber='</span><span style="color: #990000">))</span>
                    <span style="font-weight: bold"><span style="color: #0000FF">except</span></span> Exception as e<span style="color: #990000">:</span>
                        <span style="font-weight: bold"><span style="color: #0000FF">print</span></span><span style="color: #990000">(</span><span style="color: #FF0000">'Error with cam_align camera selection - not a number - using 0'</span><span style="color: #990000">)</span>

        <span style="font-style: italic"><span style="color: #9A1900"># set the camera number either as default or if -o option changed the 'number' variable, to that number.</span></span>
        self<span style="color: #990000">.</span>w<span style="color: #990000">.</span>camview<span style="color: #990000">.</span>_camNum <span style="color: #990000">=</span> number</tt></pre></div></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2023-06-18 10:43:37 CEST
</div>
</div>
</body>
</html>
